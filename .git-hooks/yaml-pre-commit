#!/bin/bash

# Git pre-commit hook for YAML format validation
# æ£€æŸ¥å³å°†æäº¤çš„YAMLæ–‡ä»¶æ ¼å¼

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# è®¡æ•°å™¨
YAML_FILES=0
INVALID_FILES=0
VALID_FILES=0

# è¾“å‡ºå‡½æ•°
print_header() {
    echo -e "${BLUE}ğŸ” Git Pre-commit Hook: YAMLæ ¼å¼æ£€æŸ¥${NC}"
    echo "====================================="
}

print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

# æ£€æŸ¥YAMLæ ¼å¼çš„å‡½æ•°
check_yaml_file() {
    local file="$1"
    ((YAML_FILES++))

    echo -e "${BLUE}æ£€æŸ¥æ–‡ä»¶: $file${NC}"

    # æ–¹æ³•1: ä½¿ç”¨Ruby YAMLæ£€æŸ¥
    if ruby -ryaml -e "YAML.load_file('$file')" 2>/dev/null; then
        ((VALID_FILES++))
        print_success "YAMLè¯­æ³•æ­£ç¡®: $file"
        return 0
    else
        # æ–¹æ³•2: ä½¿ç”¨js-yamlä½œä¸ºå¤‡é€‰æ£€æŸ¥
        if command -v npx >/dev/null 2>&1; then
            if npx js-yaml "$file" >/dev/null 2>&1; then
                ((VALID_FILES++))
                print_success "YAMLè¯­æ³•æ­£ç¡®: $file"
                return 0
            fi
        fi

        # æ–¹æ³•3: åŸºæœ¬çš„YAMLç»“æ„æ£€æŸ¥
        if python3 -c "
import sys
import re
try:
    with open('$file', 'r') as f:
        content = f.read()

    # åŸºæœ¬YAMLæ ¼å¼æ£€æŸ¥
    if not content.strip():
        print('ç©ºæ–‡ä»¶')
        sys.exit(1)

    # æ£€æŸ¥åŸºæœ¬çš„YAMLè¯­æ³•è§„åˆ™
    lines = content.split('\n')
    for i, line in enumerate(lines, 1):
        if line.strip() and not line.startswith('#'):
            # æ£€æŸ¥ç¼©è¿›ä¸€è‡´æ€§
            if re.match(r' ', line) and not re.match(r'^\s*([-\s]*\w+:|-\s+\w+:|\s+#)', line):
                print(f'ç¬¬{i}è¡Œç¼©è¿›å¯èƒ½æœ‰é—®é¢˜')
                sys.exit(1)

    print('åŸºæœ¬YAMLæ ¼å¼æ£€æŸ¥é€šè¿‡')
except Exception as e:
    print(f'æ£€æŸ¥å¤±è´¥: {e}')
    sys.exit(1)
" 2>/dev/null; then
            ((VALID_FILES++))
            print_warning "YAMLæ ¼å¼åŸºæœ¬æ­£ç¡®: $file (æœªæ‰¾åˆ°å®Œæ•´éªŒè¯å·¥å…·)"
            return 0
        else
            ((INVALID_FILES++))
            print_error "YAMLæ ¼å¼é”™è¯¯: $file"
            return 1
        fi
    fi
}

# ä¸»æ£€æŸ¥é€»è¾‘
main() {
    print_header

    # è·å–å³å°†æäº¤çš„YAMLæ–‡ä»¶åˆ—è¡¨
    yaml_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ya?ml|yaml)$' || true)

    if [ -z "$yaml_files" ]; then
        print_success "æœ¬æ¬¡æäº¤æ²¡æœ‰YAMLæ–‡ä»¶éœ€è¦æ£€æŸ¥"
        exit 0
    fi

    echo -e "${BLUE}å‘ç° ${YAML_FILES} ä¸ªYAMLæ–‡ä»¶éœ€è¦æ£€æŸ¥:${NC}"
    echo "$yaml_files" | while read -r file; do
        if [ -f "$file" ]; then
            check_yaml_file "$file"
        fi
    done

    echo
    echo "====================================="

    # å¦‚æœæ‰€æœ‰æ–‡ä»¶éƒ½é€šè¿‡æ£€æŸ¥
    if [ $INVALID_FILES -eq 0 ]; then
        print_success "æ‰€æœ‰YAMLæ–‡ä»¶æ ¼å¼æ£€æŸ¥é€šè¿‡! ğŸ‰"
        echo -e "${GREEN}æäº¤å¯ä»¥ç»§ç»­è¿›è¡Œ${NC}"
        exit 0
    else
        print_error "å‘ç° $INVALID_FILES ä¸ªYAMLæ–‡ä»¶æ ¼å¼é”™è¯¯"
        echo -e "${RED}æäº¤è¢«é˜»æ­¢ï¼Œè¯·ä¿®å¤YAMLæ ¼å¼é”™è¯¯åé‡è¯•${NC}"
        echo
        echo -e "${YELLOW}ä¿®å¤å»ºè®®:${NC}"
        echo "1. æ£€æŸ¥YAMLæ–‡ä»¶çš„ç¼©è¿›æ˜¯å¦æ­£ç¡®"
        echo "2. ç¡®ä¿å­—ç¬¦ä¸²å’Œå¸ƒå°”å€¼æ ¼å¼æ­£ç¡®"
        echo "3. éªŒè¯æ•°ç»„å’Œå¯¹è±¡çš„è¯­æ³•"
        echo "4. å¯ä»¥ä½¿ç”¨åœ¨çº¿YAMLéªŒè¯å™¨è¿›è¡Œæ£€æŸ¥"
        exit 1
    fi
}

# æ›´æ–°è®¡æ•°å™¨
update_counters() {
    local file="$1"
    ((YAML_FILES++))

    # ä½¿ç”¨Rubyæ£€æŸ¥YAMLæ ¼å¼
    if ruby -ryaml -e "YAML.load_file('$file')" 2>/dev/null; then
        ((VALID_FILES++))
        return 0
    else
        ((INVALID_FILES++))
        return 1
    fi
}

# é‡æ–°å®ç°ä¸»é€»è¾‘
main_with_counters() {
    print_header

    local file_count=0
    local error_count=0

    # è·å–å³å°†æäº¤çš„YAMLæ–‡ä»¶
    while IFS= read -r file; do
        if [ -f "$file" ]; then
            ((file_count++))
            echo -e "${BLUE}[$file_count] æ£€æŸ¥: $file${NC}"

            if update_counters "$file"; then
                print_success "é€šè¿‡: $file"
            else
                print_error "å¤±è´¥: $file"
                ((error_count++))
            fi
        fi
    done <<< "$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ya?ml|yaml)$' || true)"

    if [ $file_count -eq 0 ]; then
        print_success "æœ¬æ¬¡æäº¤æ²¡æœ‰YAMLæ–‡ä»¶éœ€è¦æ£€æŸ¥"
        exit 0
    fi

    echo
    echo "====================================="
    echo -e "${BLUE}æ£€æŸ¥ç»“æœç»Ÿè®¡:${NC}"
    echo "- æ£€æŸ¥æ–‡ä»¶æ€»æ•°: $file_count"
    echo "- é€šè¿‡æ£€æŸ¥: $((file_count - error_count))"
    echo "- æ ¼å¼é”™è¯¯: $error_count"

    echo

    if [ $error_count -eq 0 ]; then
        print_success "æ‰€æœ‰YAMLæ–‡ä»¶æ ¼å¼æ£€æŸ¥é€šè¿‡! ğŸ‰"
        exit 0
    else
        print_error "å‘ç° $error_count ä¸ªYAMLæ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œæäº¤è¢«é˜»æ­¢"
        echo
        echo -e "${YELLOW}ä¿®å¤å»ºè®®:${NC}"
        echo "1. æ£€æŸ¥YAMLç¼©è¿›æ˜¯å¦ä½¿ç”¨ç©ºæ ¼è€Œéåˆ¶è¡¨ç¬¦"
        echo "2. ç¡®ä¿é”®å€¼å¯¹ä½¿ç”¨å†’å·åˆ†éš”"
        echo "3. æ£€æŸ¥åˆ—è¡¨é¡¹ä½¿ç”¨çŸ­æ¨ªçº¿(-)å¼€å¤´"
        echo "4. ç¡®ä¿å­—ç¬¦ä¸²æ­£ç¡®å¼•å·"
        echo "5. ä½¿ç”¨åœ¨çº¿å·¥å…·éªŒè¯: https://yamllint.com/"
        exit 1
    fi
}

# æ‰§è¡Œä¸»å‡½æ•°
main_with_counters