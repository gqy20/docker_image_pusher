name: Manual Docker Image Sync

on:
  workflow_dispatch:
    inputs:
      image_list:
        description: 'è¦åŒæ­¥çš„é•œåƒåˆ—è¡¨ï¼ˆç”¨é€—å·åˆ†éš”ï¼Œä¾‹å¦‚ï¼šnginx:latest,redis:7.0,ubuntu:22.04ï¼‰'
        required: true
        type: string
      force_update:
        description: 'å¼ºåˆ¶è¦†ç›–å·²å­˜åœ¨çš„é•œåƒ'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      dry_run:
        description: 'ä»…æ£€æµ‹é•œåƒæ˜¯å¦å­˜åœ¨ï¼Œä¸å®é™…åŒæ­¥'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  ALIYUN_REGISTRY: "${{ secrets.ALIYUN_REGISTRY }}"
  ALIYUN_NAME_SPACE: "${{ secrets.ALIYUN_NAME_SPACE }}"
  ALIYUN_REGISTRY_USER: "${{ secrets.ALIYUN_REGISTRY_USER }}"
  ALIYUN_REGISTRY_PASSWORD: "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}"

jobs:
  manual-sync:
    name: æ‰‹åŠ¨é•œåƒåŒæ­¥
    runs-on: ubuntu-latest

    steps:
    - name: æ£€æŸ¥è¾“å…¥å‚æ•°
      run: |
        echo "ğŸ“‹ è¾“å…¥å‚æ•°æ£€æŸ¥ï¼š"
        echo "  é•œåƒåˆ—è¡¨: ${{ github.event.inputs.image_list }}"
        echo "  å¼ºåˆ¶æ›´æ–°: ${{ github.event.inputs.force_update }}"
        echo "  ä»…æ£€æµ‹æ¨¡å¼: ${{ github.event.inputs.dry_run }}"
        echo ""

        # æ£€æŸ¥é•œåƒåˆ—è¡¨æ˜¯å¦ä¸ºç©º
        if [[ -z "${{ github.event.inputs.image_list }}" ]]; then
          echo "âŒ é”™è¯¯ï¼šé•œåƒåˆ—è¡¨ä¸èƒ½ä¸ºç©º"
          exit 1
        fi

        echo "âœ… å‚æ•°æ£€æŸ¥é€šè¿‡"

    - name: å¢åŠ å¯ç”¨ç£ç›˜ç©ºé—´
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 2048
        swap-size-mb: 128
        remove-dotnet: 'true'
        remove-haskell: 'true'
        build-mount-path: '/var/lib/docker/'

    - name: é‡å¯ Docker
      run: sudo service docker restart

    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: Docker Setup Buildx
      uses: docker/setup-buildx-action@v3

    - name: è§£æå’ŒåŒæ­¥é•œåƒ
      run: |
        set +e  # ä¸´æ—¶ç¦ç”¨ä¸¥æ ¼æ¨¡å¼ä»¥é¿å…è„šæœ¬æ„å¤–é€€å‡º

        # è·å–è¾“å…¥å‚æ•°
        IMAGE_LIST_INPUT="${{ github.event.inputs.image_list }}"
        FORCE_UPDATE="${{ github.event.inputs.force_update }}"
        DRY_RUN="${{ github.event.inputs.dry_run }}"

        echo "ğŸš€ æ‰‹åŠ¨é•œåƒåŒæ­¥ç³»ç»Ÿå¯åŠ¨..."
        echo "=============================================================================="

        # ç™»å½•é˜¿é‡Œäº‘ä»“åº“
        echo "ğŸ” ç™»å½•é˜¿é‡Œäº‘é•œåƒä»“åº“..."
        docker login -u $ALIYUN_REGISTRY_USER -p $ALIYUN_REGISTRY_PASSWORD $ALIYUN_REGISTRY

        if [[ $? -ne 0 ]]; then
          echo "âŒ é˜¿é‡Œäº‘ä»“åº“ç™»å½•å¤±è´¥"
          exit 1
        fi

        echo "âœ… ç™»å½•æˆåŠŸ"
        echo ""

        # è§£æé•œåƒåˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼‰
        echo "ğŸ“‹ è§£æé•œåƒåˆ—è¡¨..."
        IFS=',' read -ra IMAGES <<< "$IMAGE_LIST_INPUT"

        # åˆ›å»ºä¸´æ—¶æ–‡ä»¶å­˜å‚¨è¦å¤„ç†çš„é•œåƒ
        TEMP_IMAGES_FILE="temp_manual_images.txt"
        > $TEMP_IMAGES_FILE

        VALID_IMAGES_COUNT=0

        for image_input in "${IMAGES[@]}"; do
          # å»é™¤å‰åç©ºæ ¼
          image=$(echo "$image_input" | xargs)

          # è·³è¿‡ç©ºå€¼
          if [[ -z "$image" ]]; then
            continue
          fi

          echo "ğŸ” å¤„ç†è¾“å…¥: $image"

          # éªŒè¯é•œåƒåç§°æ ¼å¼ï¼ˆç®€å•æ£€æŸ¥ï¼‰
          if echo "$image" | grep -q "^[a-zA-Z0-9._/-]\+$"; then
            echo "$image" >> $TEMP_IMAGES_FILE
            ((VALID_IMAGES_COUNT++))
            echo "âœ… é•œåƒåç§°æ ¼å¼æœ‰æ•ˆ: $image"
          else
            echo "âš ï¸  é•œåƒåç§°æ ¼å¼å¯èƒ½æœ‰é—®é¢˜ï¼Œä½†ä»å°†å°è¯•: $image"
            echo "$image" >> $TEMP_IMAGES_FILE
            ((VALID_IMAGES_COUNT++))
          fi
        done

        echo ""
        echo "ğŸ“Š è§£æç»“æœï¼š"
        echo "  è¾“å…¥é•œåƒæ•°é‡: ${#IMAGES[@]}"
        echo "  æœ‰æ•ˆé•œåƒæ•°é‡: $VALID_IMAGES_COUNT"
        echo ""

        if [[ $VALID_IMAGES_COUNT -eq 0 ]]; then
          echo "âŒ æ²¡æœ‰æœ‰æ•ˆçš„é•œåƒéœ€è¦å¤„ç†"
          exit 1
        fi

        # æ•°æ®é¢„å¤„ç†ï¼Œåˆ¤æ–­é•œåƒæ˜¯å¦é‡å
        echo "ğŸ” é¢„å¤„ç†é‡åé•œåƒåˆ†æ..."
        declare -A duplicate_images
        declare -A temp_map

        while IFS= read -r line || [ -n "$line" ]; do
          [[ -z "$line" ]] && continue

          # è·å–é•œåƒçš„å®Œæ•´åç§°
          image=$(echo "$line" | awk '{print $NF}')
          image="${image%%@*}"

          # è·å–é•œåƒå:ç‰ˆæœ¬å·
          image_name_tag=$(echo "$image" | awk -F'/' '{print $NF}')

          # è·å–å‘½åç©ºé—´
          name_space=$(echo "$image" | awk -F'/' '{if (NF==3) print $2; else if (NF==2) print $1; else print ""}')
          name_space="${name_space}_"

          # è·å–é•œåƒå
          image_name=$(echo "$image_name_tag" | awk -F':' '{print $1}')

          # æ£€æµ‹é‡åé•œåƒ
          if [[ -n "${temp_map[$image_name]}" ]]; then
            if [[ "${temp_map[$image_name]}" != $name_space ]]; then
              echo "duplicate image name: $image_name"
              duplicate_images[$image_name]="true"
            fi
          else
            temp_map[$image_name]=$name_space
          fi
        done < $TEMP_IMAGES_FILE

        echo ""
        echo "ğŸ”„ å¼€å§‹å¤„ç†é•œåƒ..."

        TOTAL_COUNT=0
        SUCCESS_COUNT=0
        SKIP_COUNT=0

        while IFS= read -r line || [ -n "$line" ]; do
          [[ -z "$line" ]] && continue

          ((TOTAL_COUNT++))
          echo ""
          echo "ğŸ“¦ å¤„ç†é•œåƒ [$TOTAL_COUNT/$VALID_IMAGES_COUNT]: $line"

          # è·å–platformå‚æ•°å’Œé•œåƒå
          platform=""
          if echo "$line" | grep -q -- '--platform'; then
            platform=$(echo "$line" | awk -F'--platform[ =]' '{if (NF>1) print $2}' | awk '{print $1}')
            image=$(echo "$line" | awk '{print $NF}')
          else
            image="$line"
          fi

          # ç”Ÿæˆæœ€ç»ˆç›®æ ‡é•œåƒåç§°
          image_name_tag=$(echo "$image" | awk -F'/' '{print $NF}')
          name_space=$(echo "$image" | awk -F'/' '{if (NF==3) print $2; else if (NF==2) print $1; else print ""}')
          name_space="${name_space}_"
          image_name=$(echo "$image_name_tag" | awk -F':' '{print $1}')

          # å¤„ç†é‡åé•œåƒ
          name_space_prefix=""
          if [[ -n "${duplicate_images[$image_name]}" ]]; then
            if [[ -n "${name_space}" ]]; then
              name_space_prefix="${name_space}"
            fi
          fi

          # å¤„ç†platformå‰ç¼€
          platform_prefix=""
          if [ -n "$platform" ]; then
            platform_prefix="${platform//\//_}_"
          fi

          # å°†@sha256:ç­‰å­—ç¬¦åˆ é™¤
          image_name_tag="${image_name_tag%%@*}"

          # ç”Ÿæˆæœ€ç»ˆé•œåƒå
          final_image="$ALIYUN_REGISTRY/$ALIYUN_NAME_SPACE/$platform_prefix$name_space_prefix$image_name_tag"

          echo "ğŸ¯ ç›®æ ‡é•œåƒ: $final_image"

          # æ£€æŸ¥é•œåƒæ˜¯å¦å·²å­˜åœ¨
          if docker manifest inspect $final_image >/dev/null 2>&1; then
            if [[ "$FORCE_UPDATE" == "true" ]]; then
              echo "ğŸ”„ é•œåƒå·²å­˜åœ¨ï¼Œå¼ºåˆ¶æ›´æ–°æ¨¡å¼: $final_image"
            else
              echo "â­ï¸  é•œåƒå·²å­˜åœ¨ï¼Œè·³è¿‡: $final_image"
              ((SKIP_COUNT++))
              continue
            fi
          fi

          # ä»…æ£€æµ‹æ¨¡å¼
          if [[ "$DRY_RUN" == "true" ]]; then
            echo "ğŸ” [ä»…æ£€æµ‹] é•œåƒéœ€è¦åŒæ­¥: $image"
            ((SUCCESS_COUNT++))
            continue
          fi

          # æ‰§è¡Œé•œåƒåŒæ­¥
          echo "ğŸ”„ docker pull $line"
          if docker pull $line; then
            echo "âœ… æ‹‰å–æˆåŠŸ"

            echo "ğŸ·ï¸  docker tag $image $final_image"
            docker tag $image $final_image

            echo "ğŸ“¤ docker push $final_image"
            if docker push $final_image; then
              ((SUCCESS_COUNT++))
              echo "âœ… æ¨é€æˆåŠŸ: $final_image"
            else
              echo "âŒ æ¨é€å¤±è´¥: $final_image"
            fi

            # æ¸…ç†æœ¬åœ°é•œåƒ
            echo "ğŸ§¹ æ¸…ç†æœ¬åœ°é•œåƒ..."
            docker rmi $image 2>/dev/null || true
            docker rmi $final_image 2>/dev/null || true

          else
            echo "âŒ æ‹‰å–å¤±è´¥: $line"
          fi

        done < $TEMP_IMAGES_FILE

        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -f $TEMP_IMAGES_FILE

        echo ""
        echo "=============================================================================="
        echo "ğŸ“Š æ‰‹åŠ¨é•œåƒåŒæ­¥å®Œæˆç»Ÿè®¡:"
        echo "  ğŸ“‹ æ€»è®¡å¤„ç†: $TOTAL_COUNT ä¸ªé•œåƒ"
        echo "  âœ… åŒæ­¥æˆåŠŸ: $SUCCESS_COUNT ä¸ªé•œåƒ"
        echo "  â­ï¸  è·³è¿‡å·²å­˜åœ¨: $SKIP_COUNT ä¸ªé•œåƒ"
        echo "  âŒ å¤±è´¥æ•°é‡: $((TOTAL_COUNT - SUCCESS_COUNT - SKIP_COUNT)) ä¸ªé•œåƒ"

        if [[ "$DRY_RUN" == "true" ]]; then
          echo "  ğŸ” æ¨¡å¼: ä»…æ£€æµ‹ï¼Œæœªå®é™…åŒæ­¥"
        fi

        if [[ "$FORCE_UPDATE" == "true" ]]; then
          echo "  ğŸ”„ æ¨¡å¼: å¼ºåˆ¶æ›´æ–°"
        fi

        echo "=============================================================================="