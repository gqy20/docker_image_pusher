name: Docker

on:
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'å¼ºåˆ¶åŒæ­¥æ‰€æœ‰é•œåƒï¼ˆå¿½ç•¥ç°æœ‰ä»“åº“çŠ¶æ€ï¼‰'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
  push:
    branches: [ main ]
    # ç§»é™¤pathsé™åˆ¶ï¼Œå…è®¸ä»»æ„pushè§¦å‘æ™ºèƒ½åŒæ­¥æ£€æŸ¥
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ8ç‚¹æ‰§è¡Œæ™ºèƒ½åŒæ­¥æ£€æŸ¥
    - cron: '0 0 * * *'


env:
  ALIYUN_REGISTRY: "${{ secrets.ALIYUN_REGISTRY }}"
  ALIYUN_NAME_SPACE: "${{ secrets.ALIYUN_NAME_SPACE }}"
  ALIYUN_REGISTRY_USER: "${{ secrets.ALIYUN_REGISTRY_USER }}"
  ALIYUN_REGISTRY_PASSWORD: "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}"

jobs:

  build:
    name: Pull
    runs-on: ubuntu-latest
    env:
      ALIYUN_REGISTRY: ${{ secrets.ALIYUN_REGISTRY }}
      ALIYUN_NAME_SPACE: ${{ secrets.ALIYUN_NAME_SPACE }}
      ALIYUN_REGISTRY_USER: ${{ secrets.ALIYUN_REGISTRY_USER }}
      ALIYUN_REGISTRY_PASSWORD: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}
    steps:
    - name: Before freeing up disk space
      run: |
        echo "Before freeing up disk space"
        echo "=============================================================================="
        df -hT
        echo "=============================================================================="

    # å¢åŠ å¯ç”¨ç£ç›˜ç©ºé—´
    - name: Maximize build space
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 2048
        swap-size-mb: 128
        remove-dotnet: 'true'
        remove-haskell: 'true'
        # å¦‚æœç©ºé—´è¿˜æ˜¯ä¸å¤Ÿç”¨ï¼Œå¯ä»¥æŠŠä»¥ä¸‹å¼€å¯ï¼Œæ¸…ç†å‡ºæ›´å¤šç©ºé—´
        # remove-android: 'true'
        # remove-codeql: 'true'
        build-mount-path: '/var/lib/docker/'

    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Docker Environment Setup
      run: |
        # ä½¿ç”¨å…±äº«çš„Dockerç¯å¢ƒè®¾ç½®è„šæœ¬
        ./scripts/docker-setup.sh

    - name: Free up disk space complete
      run: |
        echo "Free up disk space complete"
        echo "=============================================================================="
        df -hT
        echo "=============================================================================="

    - name: Docker Setup Buildx
      uses: docker/setup-buildx-action@v3

    - name: Analyze duplicate images
      run: |
        # ä½¿ç”¨é‡å¤é•œåƒåˆ†æè„šæœ¬
        ./scripts/duplicate-analyzer.sh -f images.txt -o duplicate-report.md -r github

    - name: Build and push image Aliyun
      run: |
        set -e  # å¯ç”¨ä¸¥æ ¼æ¨¡å¼
        docker login -u $ALIYUN_REGISTRY_USER -p $ALIYUN_REGISTRY_PASSWORD $ALIYUN_REGISTRY

        echo "ğŸ” ç»Ÿä¸€é•œåƒåŒæ­¥ç³»ç»Ÿå¯åŠ¨..."
        echo "=============================================================================="
        echo "ğŸ“‚ å‘½åç©ºé—´: $ALIYUN_NAME_SPACE"
        echo "=============================================================================="

        # ä½¿ç”¨ç»Ÿä¸€åŒæ­¥å¤„ç†å™¨ - è‡ªåŠ¨æ£€æµ‹é…ç½®æ–‡ä»¶æ ¼å¼
        if [[ "${{ github.event.inputs.force_sync }}" == "true" ]]; then
            echo "âš¡ å¼ºåˆ¶åŒæ­¥æ¨¡å¼ï¼šåŒæ­¥æ‰€æœ‰é•œåƒ"
            ./scripts/unified_sync.py --force -o sync-result.env
        else
            echo "ğŸ” æ™ºèƒ½åŒæ­¥æ¨¡å¼ï¼šä»…åŒæ­¥éœ€è¦çš„é•œåƒ"
            ./scripts/unified_sync.py --smart -o sync-result.env
        fi

        # è¯»å–å¹¶æ˜¾ç¤ºç»“æœ
        if [ -f sync-result.env ]; then
            source sync-result.env
            echo "ğŸ“Š åŒæ­¥ç»“æœ:"
            echo "  ğŸ“‹ å¤„ç†æ€»æ•°: $TOTAL_COUNT ä¸ªé•œåƒ"
            echo "  âœ… åŒæ­¥æˆåŠŸ: $SUCCESS_COUNT ä¸ªé•œåƒ"
            echo "  âŒ åŒæ­¥å¤±è´¥: $FAILED_COUNT ä¸ªé•œåƒ"

            # æ˜¾ç¤ºæˆåŠŸå’Œå¤±è´¥çš„é•œåƒè¯¦æƒ…
            if [ "$SUCCESS_COUNT" -gt 0 ]; then
                echo "ğŸ‰ æˆåŠŸåŒæ­¥çš„é•œåƒ:"
                echo "$SUCCESS_IMAGES" | grep "^âœ…" || echo "  è¯¦æƒ…è¯·æŸ¥çœ‹æ—¥å¿—"
            fi

            if [ "$FAILED_COUNT" -gt 0 ]; then
                echo "âš ï¸ åŒæ­¥å¤±è´¥çš„é•œåƒ:"
                echo "$FAILED_IMAGES" | grep "^âŒ" || echo "  è¯¦æƒ…è¯·æŸ¥çœ‹æ—¥å¿—"
            fi
        else
            echo "âŒ æœªæ‰¾åˆ°åŒæ­¥ç»“æœæ–‡ä»¶"
            exit 1
        fi