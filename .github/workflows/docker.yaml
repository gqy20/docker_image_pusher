name: Docker

on:
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'å¼ºåˆ¶åŒæ­¥æ‰€æœ‰é•œåƒï¼ˆå¿½ç•¥ç°æœ‰ä»“åº“çŠ¶æ€ï¼‰'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
  push:
    branches: [ main ]
    # ç§»é™¤pathsé™åˆ¶ï¼Œå…è®¸ä»»æ„pushè§¦å‘æ™ºèƒ½åŒæ­¥æ£€æŸ¥
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ8ç‚¹æ‰§è¡Œæ™ºèƒ½åŒæ­¥æ£€æŸ¥
    - cron: '0 0 * * *'


env:
  ALIYUN_REGISTRY: "${{ secrets.ALIYUN_REGISTRY }}"
  ALIYUN_NAME_SPACE: "${{ secrets.ALIYUN_NAME_SPACE }}"
  ALIYUN_REGISTRY_USER: "${{ secrets.ALIYUN_REGISTRY_USER }}"
  ALIYUN_REGISTRY_PASSWORD: "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}"

jobs:

  build:
    name: Pull
    runs-on: ubuntu-latest
    steps:
    - name: Before freeing up disk space
      run: |
        echo "Before freeing up disk space"
        echo "=============================================================================="
        df -hT
        echo "=============================================================================="

    # å¢åŠ å¯ç”¨ç£ç›˜ç©ºé—´
    - name: Maximize build space
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 2048
        swap-size-mb: 128
        remove-dotnet: 'true'
        remove-haskell: 'true'
        # å¦‚æœç©ºé—´è¿˜æ˜¯ä¸å¤Ÿç”¨ï¼Œå¯ä»¥æŠŠä»¥ä¸‹å¼€å¯ï¼Œæ¸…ç†å‡ºæ›´å¤šç©ºé—´
        # remove-android: 'true'
        # remove-codeql: 'true'
        build-mount-path: '/var/lib/docker/'

    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Docker Environment Setup
      run: |
        # ä½¿ç”¨å…±äº«çš„Dockerç¯å¢ƒè®¾ç½®è„šæœ¬
        ./scripts/docker-setup.sh

    - name: Free up disk space complete
      run: |
        echo "Free up disk space complete"
        echo "=============================================================================="
        df -hT
        echo "=============================================================================="

    - name: Docker Setup Buildx
      uses: docker/setup-buildx-action@v3

    - name: Analyze duplicate images
      run: |
        # ä½¿ç”¨é‡å¤é•œåƒåˆ†æè„šæœ¬
        ./scripts/duplicate-analyzer.sh -f images.txt -o duplicate-report.md -r github

    - name: Build and push image Aliyun
      run: |
        set +e  # ä¸´æ—¶ç¦ç”¨ä¸¥æ ¼æ¨¡å¼ä»¥é¿å…è„šæœ¬æ„å¤–é€€å‡º
        docker login -u $ALIYUN_REGISTRY_USER -p $ALIYUN_REGISTRY_PASSWORD $ALIYUN_REGISTRY

        echo "ğŸ” æ™ºèƒ½é•œåƒåŒæ­¥ç³»ç»Ÿå¯åŠ¨..."
        echo "=============================================================================="

        echo "ğŸ“‚ å‘½åç©ºé—´: $ALIYUN_NAME_SPACE"
        echo "=============================================================================="

        # è·å–é˜¿é‡Œäº‘ä»“åº“ä¸­å·²æœ‰çš„é•œåƒåˆ—è¡¨
        echo "ğŸ“Š æ­£åœ¨æŸ¥è¯¢é˜¿é‡Œäº‘ä»“åº“ä¸­çš„é•œåƒ..."

        # ç®€åŒ–çš„ä»“åº“æ£€æµ‹æ–¹æ³•
        echo "ğŸ” ä½¿ç”¨Dockeræ£€æµ‹ç°æœ‰é•œåƒ..."

        # ä½¿ç”¨æ”¹è¿›çš„é‡åæ£€æµ‹é€»è¾‘ï¼Œä¸åŒæ­¥é˜¶æ®µä¿æŒä¸€è‡´
        echo "ğŸ” é¢„å¤„ç†é‡åé•œåƒåˆ†æ..."
        declare -A duplicate_images
        declare -A temp_map

        # é¦–å…ˆè¿›è¡Œé‡ååˆ†æ
        while IFS= read -r line || [ -n "$line" ]; do
            # å¿½ç•¥ç©ºè¡Œä¸æ³¨é‡Š
            [[ -z "$line" ]] && continue
            if echo "$line" | grep -q '^\s*#'; then
                continue
            fi

            # æå–é•œåƒä¿¡æ¯
            if echo "$line" | grep -q -- '--platform'; then
                image=$(echo "$line" | awk '{print $NF}')
                platform=$(echo "$line" | awk -F'--platform[ =]' '{if (NF>1) print $2}' | awk '{print $1}')
            else
                image="$line"
                platform=""
            fi

            # å°†@sha256:ç­‰å­—ç¬¦åˆ é™¤
            image="${image%%@*}"

            # è·å–é•œåƒå:ç‰ˆæœ¬å·
            image_name_tag=$(echo "$image" | awk -F'/' '{print $NF}')
            image_name=$(echo "$image_name_tag" | awk -F':' '{print $1}')

            # è·å–å‘½åç©ºé—´
            name_space=$(echo "$image" | awk -F'/' '{if (NF==3) print $2; else if (NF==2) print $1; else print ""}')

            # æ£€æµ‹é‡åé•œåƒ
            if [[ -n "${temp_map[$image_name]}" ]]; then
                 if [[ "${temp_map[$image_name]}" != "$name_space" ]]; then
                    echo "ğŸ”„ å‘ç°é‡åé•œåƒ: $image_name"
                    duplicate_images[$image_name]="true"
                 fi
            else
                temp_map[$image_name]="$name_space"
            fi
        done < images.txt

        # ä¸´æ—¶å­˜å‚¨å·²æ£€æµ‹åˆ°çš„é•œåƒ
        EXISTING_IMAGES=""

        # æ£€æµ‹é•œåƒæ˜¯å¦å­˜åœ¨ï¼ˆä½¿ç”¨ä¸åŒæ­¥é˜¶æ®µå®Œå…¨ä¸€è‡´çš„é€»è¾‘ï¼‰
        while IFS= read -r line || [ -n "$line" ]; do
            # å¿½ç•¥ç©ºè¡Œä¸æ³¨é‡Š
            [[ -z "$line" ]] && continue
            if echo "$line" | grep -q '^\s*#'; then
                continue
            fi

            # æå–é•œåƒä¿¡æ¯ï¼ˆä¸åŒæ­¥é˜¶æ®µé€»è¾‘ä¸€è‡´ï¼‰
            if echo "$line" | grep -q -- '--platform'; then
                image=$(echo "$line" | awk '{print $NF}')
                platform=$(echo "$line" | awk -F'--platform[ =]' '{if (NF>1) print $2}' | awk '{print $1}')
            else
                image="$line"
                platform=""
            fi

            # å°†@sha256:ç­‰å­—ç¬¦åˆ é™¤
            image="${image%%@*}"

            # è·å–é•œåƒå:ç‰ˆæœ¬å·
            image_name_tag=$(echo "$image" | awk -F'/' '{print $NF}')

            # è·å–å‘½åç©ºé—´
            name_space=$(echo "$image" | awk -F'/' '{if (NF==3) print $2; else if (NF==2) print $1; else print ""}')

            # è·å–é•œåƒå
            image_name=$(echo "$image_name_tag" | awk -F':' '{print $1}')

            # ç”Ÿæˆå¹³å°å‰ç¼€ï¼ˆä¸åŒæ­¥é˜¶æ®µé€»è¾‘ä¸€è‡´ï¼‰
            platform_prefix=""
            if [ -n "$platform" ]; then
                platform_prefix="${platform//\//_}_"
            fi

            # å¤„ç†é‡åé•œåƒï¼ˆä¸åŒæ­¥é˜¶æ®µé€»è¾‘ä¸€è‡´ï¼‰
            name_space_prefix=""
            if [[ -n "${duplicate_images[$image_name]}" ]]; then
               if [[ -n "$name_space" ]]; then
                  name_space_prefix="${name_space}_"
               fi
            fi

            # ç”Ÿæˆæœ€ç»ˆé•œåƒåï¼ˆä¸åŒæ­¥é˜¶æ®µå®Œå…¨ä¸€è‡´ï¼‰
            image_name_tag="${image_name_tag%%@*}"
            final_image="$ALIYUN_REGISTRY/$ALIYUN_NAME_SPACE/${platform_prefix}${name_space_prefix}${image_name_tag}"

            echo "ğŸ” æ£€æµ‹é•œåƒ: $final_image (åŸå§‹: $line)"

            # ä½¿ç”¨docker manifestæ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨
            if docker manifest inspect $final_image >/dev/null 2>&1; then
                echo "âœ… é•œåƒå·²å­˜åœ¨: $final_image"
                if [[ -n "$EXISTING_IMAGES" ]]; then
                    EXISTING_IMAGES="$EXISTING_IMAGES$image_name"$'\n'
                else
                    EXISTING_IMAGES="$image_name"$'\n'
                fi
            else
                echo "âŒ é•œåƒä¸å­˜åœ¨: $final_image"
            fi
        done < images.txt

        echo "ğŸ“¦ Dockeræ£€æµ‹ç»“æœå®Œæˆ"
        EXISTING_REPOS="$EXISTING_IMAGES"

        echo "=============================================================================="

        # åˆ†æimages.txtä¸­çš„é•œåƒéœ€æ±‚
        echo "ğŸ” åˆ†æé•œåƒåŒæ­¥éœ€æ±‚..."

        NEEDED_IMAGES=""
        TOTAL_IMAGES=0
        NEEDED_COUNT=0

        while IFS= read -r line || [ -n "$line" ]; do
            # å¿½ç•¥ç©ºè¡Œä¸æ³¨é‡Š
            [[ -z "$line" ]] && continue
            if echo "$line" | grep -q '^\s*#'; then
                continue
            fi

            ((TOTAL_IMAGES++))

            # æå–é•œåƒä¿¡æ¯
            if echo "$line" | grep -q -- '--platform'; then
                image=$(echo "$line" | awk '{print $NF}')
                platform=$(echo "$line" | awk -F'--platform[ =]' '{if (NF>1) print $2}' | awk '{print $1}')
            else
                image="$line"
                platform=""
            fi

            # è§£æé•œåƒåå’Œæ ‡ç­¾
            if echo "$image" | grep -q ":"; then
                repo_part=$(echo "$image" | cut -d':' -f1)
                tag_part=$(echo "$image" | cut -d':' -f2)
            else
                repo_part="$image"
                tag_part="latest"
            fi

            # è·å–æœ€ç»ˆé•œåƒåï¼ˆå»é™¤å‘½åç©ºé—´å‰ç¼€ï¼‰
            final_name=$(echo "$repo_part" | awk -F'/' '{print $NF}')
            final_image="${final_name}:${tag_part}"

            # å¤„ç†é‡åé•œåƒ
            if echo "$EXISTING_IMAGES" | grep -q "^$final_name$"; then
                echo "âœ… é•œåƒå·²å­˜åœ¨: $final_image"
                # è¿™é‡Œå¯ä»¥è¿›ä¸€æ­¥æ£€æŸ¥æ ‡ç­¾æ˜¯å¦éœ€è¦æ›´æ–°
                # æš‚æ—¶å‡è®¾å·²å­˜åœ¨çš„é•œåƒä¸éœ€è¦æ›´æ–°
            else
                echo "ğŸ†• éœ€è¦åŒæ­¥: $final_image"
                ((NEEDED_COUNT++))
                if [[ -n "$NEEDED_IMAGES" ]]; then
                    NEEDED_IMAGES="$NEEDED_IMAGES$line"$'\n'
                else
                    NEEDED_IMAGES="$line"$'\n'
                fi
            fi

        done < images.txt

        echo "=============================================================================="
        echo "ğŸ“Š åŒæ­¥éœ€æ±‚åˆ†æç»“æœ:"
        echo "  ğŸ“‹ é…ç½®æ€»æ•°: $TOTAL_IMAGES ä¸ªé•œåƒ"
        echo "  âœ… å·²å­˜åœ¨: $((TOTAL_IMAGES - NEEDED_COUNT)) ä¸ªé•œåƒ"
        echo "  ğŸ†• éœ€è¦åŒæ­¥: $NEEDED_COUNT ä¸ªé•œåƒ"
        echo "=============================================================================="

        # å¦‚æœæ²¡æœ‰éœ€è¦åŒæ­¥çš„é•œåƒï¼Œç›´æ¥é€€å‡º
        if [[ $NEEDED_COUNT -eq 0 ]]; then
            echo "ğŸ‰ æ‰€æœ‰é•œåƒå·²å­˜åœ¨ï¼Œæ— éœ€åŒæ­¥"
            exit 0
        fi

        # åˆ›å»ºä¸´æ—¶æ–‡ä»¶åªåŒ…å«éœ€è¦åŒæ­¥çš„é•œåƒ
        # ç¡®ä¿æ–‡ä»¶æœ«å°¾æ²¡æœ‰å¤šä½™çš„ç©ºè¡Œ
        echo -n "$NEEDED_IMAGES" > temp_images.txt

        echo "ğŸš€ å¼€å§‹åŒæ­¥ç¼ºå¤±çš„é•œåƒ..."

        # ä½¿ç”¨é•œåƒå¤„ç†è„šæœ¬è¿›è¡ŒåŒæ­¥ï¼ˆå¯ç”¨æ™ºèƒ½åŒæ­¥æ¨¡å¼ï¼‰
        ./scripts/image-processor.sh -f temp_images.txt -o sync-result.env -s

        # è¯»å–ç»“æœ
        if [ -f sync-result.env ]; then
            source sync-result.env
        fi

        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -f temp_images.txt sync-result.env

        echo ""
        echo "=============================================================================="
        echo "ğŸ“Š æ™ºèƒ½åŒæ­¥å®Œæˆç»Ÿè®¡:"
        echo "  ğŸ“‹ é…ç½®æ€»æ•°: $TOTAL_IMAGES ä¸ªé•œåƒ"
        echo "  ğŸ†• æ–°å¢åŒæ­¥: ${SUCCESS_COUNT:-0} ä¸ªé•œåƒ"
        echo "  âŒ å¤±è´¥æ•°é‡: $((TOTAL_COUNT - ${SUCCESS_COUNT:-0})) ä¸ªé•œåƒ"
        echo "=============================================================================="

    env:
      ALIYUN_REGISTRY: ${{ secrets.ALIYUN_REGISTRY }}
      ALIYUN_NAME_SPACE: ${{ secrets.ALIYUN_NAME_SPACE }}
      ALIYUN_REGISTRY_USER: ${{ secrets.ALIYUN_REGISTRY_USER }}
      ALIYUN_REGISTRY_PASSWORD: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}