name: Docker

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'images.txt'  # åªæœ‰images.txtå˜åŒ–æ—¶æ‰è§¦å‘


env:
  ALIYUN_REGISTRY: "${{ secrets.ALIYUN_REGISTRY }}"
  ALIYUN_NAME_SPACE: "${{ secrets.ALIYUN_NAME_SPACE }}"
  ALIYUN_REGISTRY_USER: "${{ secrets.ALIYUN_REGISTRY_USER }}"
  ALIYUN_REGISTRY_PASSWORD: "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}"

jobs:

  build:
    name: Pull
    runs-on: ubuntu-latest
    steps:
    - name: Before freeing up disk space
      run: |
        echo "Before freeing up disk space"
        echo "=============================================================================="
        df -hT
        echo "=============================================================================="

    # å¢åŠ å¯ç”¨ç£ç›˜ç©ºé—´
    - name: Maximize build space
      uses: easimon/maximize-build-space@master
      with:

        root-reserve-mb: 2048
        swap-size-mb: 128
        remove-dotnet: 'true'
        remove-haskell: 'true'
        # å¦‚æœç©ºé—´è¿˜æ˜¯ä¸å¤Ÿç”¨ï¼Œå¯ä»¥æŠŠä»¥ä¸‹å¼€å¯ï¼Œæ¸…ç†å‡ºæ›´å¤šç©ºé—´
        # remove-android: 'true'
        # remove-codeql: 'true'
        build-mount-path: '/var/lib/docker/'

    - name: Restart docker
      run: sudo service docker restart

    - name: Free up disk space complete
      run: |
        echo "Free up disk space complete"
        echo "=============================================================================="
        df -hT
        echo "=============================================================================="

    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Docker Setup Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and push image Aliyun
      run: |
        docker login -u $ALIYUN_REGISTRY_USER -p $ALIYUN_REGISTRY_PASSWORD $ALIYUN_REGISTRY

        echo "ğŸ” æ£€æŸ¥images.txtå˜æ›´æƒ…å†µ..."

        # è·å–å½“å‰æäº¤çš„çˆ¶æäº¤æ•°é‡
        PARENT_COUNT=$(git rev-list --count HEAD~1 2>/dev/null || echo "0")
        echo "ğŸ“Š Gitå†å²æ£€æŸ¥: çˆ¶æäº¤æ•°é‡ = $PARENT_COUNT"

        if [[ "$PARENT_COUNT" -gt 0 ]]; then
          echo "ğŸ“Š æ£€æµ‹åˆ°gitå†å²ï¼Œåˆ†æå˜æ›´..."

          # æ£€æŸ¥images.txtæ˜¯å¦æœ‰å˜åŒ–
          if git diff --quiet HEAD~1 HEAD -- images.txt; then
            echo "âœ… images.txtæ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡é•œåƒåŒæ­¥"
            exit 0
          fi

          echo "ğŸ”„ images.txtæœ‰å˜åŒ–ï¼Œåˆ†æå…·ä½“å˜æ›´..."
          echo "=============================================================================="

          # è·å–æ–°å¢å’Œä¿®æ”¹çš„é•œåƒè¡Œ
          CHANGED_IMAGES=$(git diff HEAD~1 HEAD -- images.txt | grep '^\+' | grep -v '^+++' | sed 's/^\+//' | grep -v '^#' | grep -v '^$' || true)

          if [[ -z "$CHANGED_IMAGES" ]]; then
            echo "â„¹ï¸  æ²¡æœ‰æ–°çš„é•œåƒéœ€è¦åŒæ­¥ï¼ˆå¯èƒ½åªæ˜¯æ³¨é‡Šå˜åŒ–ï¼‰"
            exit 0
          fi

          echo "ğŸ“‹ å‘ç°ä»¥ä¸‹é•œåƒéœ€è¦å¤„ç†ï¼š"
          echo "$CHANGED_IMAGES"
          echo "=============================================================================="

          # åˆ›å»ºä¸´æ—¶æ–‡ä»¶åªåŒ…å«éœ€è¦å¤„ç†çš„é•œåƒ
          echo "$CHANGED_IMAGES" > temp_images.txt
          IMAGES_FILE="temp_images.txt"
        else
          echo "ğŸ†• é¦–æ¬¡æäº¤æˆ–æ— å†å²è®°å½•ï¼Œå¤„ç†æ‰€æœ‰é•œåƒ..."
          IMAGES_FILE="images.txt"
        fi

        echo "ğŸš€ å¼€å§‹åŒæ­¥é•œåƒ..."

        # æ•°æ®é¢„å¤„ç†,åˆ¤æ–­é•œåƒæ˜¯å¦é‡å
        declare -A duplicate_images
        declare -A temp_map
        while IFS= read -r line || [ -n "$line" ]; do
            # å¿½ç•¥ç©ºè¡Œä¸æ³¨é‡Š
            [[ -z "$line" ]] && continue
            if echo "$line" | grep -q '^\s*#'; then
                continue
            fi

            # è·å–é•œåƒçš„å®Œæ•´åç§°ï¼Œä¾‹å¦‚kasmweb/nginx:1.25.3ï¼ˆå‘½åç©ºé—´/é•œåƒå:ç‰ˆæœ¬å·ï¼‰
            image=$(echo "$line" | awk '{print $NF}')
            # å°†@sha256:ç­‰å­—ç¬¦åˆ é™¤
            image="${image%%@*}"
            echo "image $image"
            # è·å–é•œåƒå:ç‰ˆæœ¬å·  ä¾‹å¦‚nginx:1.25.3
            image_name_tag=$(echo "$image" | awk -F'/' '{print $NF}')
            echo "image_name_tag $image_name_tag"
            # è·å–å‘½åç©ºé—´ ä¾‹å¦‚kasmweb,  è¿™é‡Œæœ‰ç§ç‰¹æ®Šæƒ…å†µ docker.io/nginxï¼ŒæŠŠdocker.ioå½“æˆå‘½åç©ºé—´ï¼Œä¹ŸOK
            name_space=$(echo "$image" | awk -F'/' '{if (NF==3) print $2; else if (NF==2) print $1; else print ""}')
            echo "name_space: $name_space"
            # è¿™é‡Œä¸è¦æ˜¯ç©ºå€¼å½±å“åˆ¤æ–­
            name_space="${name_space}_"
            # è·å–é•œåƒåä¾‹å¦‚nginx
            image_name=$(echo "$image_name_tag" | awk -F':' '{print $1}')
            echo "image_name: $image_name"

            # å¦‚æœé•œåƒå­˜åœ¨äºæ•°ç»„ä¸­ï¼Œåˆ™æ·»åŠ temp_map
            if [[ -n "${temp_map[$image_name]}" ]]; then
                 # å¦‚æœtemp_mapå·²ç»å­˜åœ¨é•œåƒåï¼Œåˆ¤æ–­æ˜¯ä¸æ˜¯åŒä¸€å‘½åç©ºé—´
                 if [[ "${temp_map[$image_name]}" != $name_space  ]]; then
                    echo "duplicate image name: $image_name"
                    duplicate_images[$image_name]="true"
                 fi
            else
                # å­˜é•œåƒçš„å‘½åç©ºé—´
                temp_map[$image_name]=$name_space
            fi
        done < $IMAGES_FILE

        echo ""
        echo "ğŸ”„ å¼€å§‹å¤„ç†é•œåƒæ‹‰å–å’Œæ¨é€..."

        TOTAL_COUNT=0
        SUCCESS_COUNT=0

        while IFS= read -r line || [ -n "$line" ]; do
            # å¿½ç•¥ç©ºè¡Œä¸æ³¨é‡Š
            [[ -z "$line" ]] && continue
            if echo "$line" | grep -q '^\s*#'; then
                continue
            fi

            ((TOTAL_COUNT++))
            echo ""
            echo "ğŸ“¦ å¤„ç†é•œåƒ [$TOTAL_COUNT]: $line"

            echo "ğŸ”„ docker pull $line"
            if docker pull $line; then
                echo "âœ… æ‹‰å–æˆåŠŸ"
                platform=$(echo "$line" | awk -F'--platform[ =]' '{if (NF>1) print $2}' | awk '{print $1}')
                echo "platform is $platform"
                # å¦‚æœå­˜åœ¨æ¶æ„ä¿¡æ¯ å°†æ¶æ„ä¿¡æ¯æ‹¼åˆ°é•œåƒåç§°å‰é¢
                if [ -z "$platform" ]; then
                    platform_prefix=""
                else
                    platform_prefix="${platform//\//_}_"
                fi
                echo "platform_prefix is $platform_prefix"
                # è·å–é•œåƒçš„å®Œæ•´åç§°ï¼Œä¾‹å¦‚kasmweb/nginx:1.25.3ï¼ˆå‘½åç©ºé—´/é•œåƒå:ç‰ˆæœ¬å·ï¼‰
                image=$(echo "$line" | awk '{print $NF}')

                # è·å– é•œåƒå:ç‰ˆæœ¬å·  ä¾‹å¦‚nginx:1.25.3
                image_name_tag=$(echo "$image" | awk -F'/' '{print $NF}')
                # è·å–å‘½åç©ºé—´ ä¾‹å¦‚kasmweb  è¿™é‡Œæœ‰ç§ç‰¹æ®Šæƒ…å†µ docker.io/nginxï¼ŒæŠŠdocker.ioå½“æˆå‘½åç©ºé—´ï¼Œä¹ŸOK
                name_space=$(echo "$image" | awk -F'/' '{if (NF==3) print $2; else if (NF==2) print $1; else print ""}')
                # è·å–é•œåƒåä¾‹  ä¾‹å¦‚nginx
                image_name=$(echo "$image_name_tag" | awk -F':' '{print $1}')

                name_space_prefix=""
                # å¦‚æœé•œåƒåé‡å
                if [[ -n "${duplicate_images[$image_name]}" ]]; then
                   #å¦‚æœå‘½åç©ºé—´éç©ºï¼Œå°†å‘½åç©ºé—´åŠ åˆ°å‰ç¼€
                   if [[ -n "${name_space}" ]]; then
                      name_space_prefix="${name_space}_"
                   fi
                fi

                # å°†@sha256:ç­‰å­—ç¬¦åˆ é™¤
                image_name_tag="${image_name_tag%%@*}"
                new_image="$ALIYUN_REGISTRY/$ALIYUN_NAME_SPACE/$platform_prefix$name_space_prefix$image_name_tag"
                echo "ğŸ·ï¸  docker tag $image $new_image"
                docker tag $image $new_image
                echo "ğŸ“¤ docker push $new_image"
                if docker push $new_image; then
                    ((SUCCESS_COUNT++))
                    echo "âœ… æ¨é€æˆåŠŸ: $new_image"
                else
                    echo "âŒ æ¨é€å¤±è´¥: $new_image"
                fi

                # æ¸…ç†æœ¬åœ°é•œåƒ
                echo "ğŸ§¹ æ¸…ç†æœ¬åœ°é•œåƒ..."
                docker rmi $image 2>/dev/null || true
                docker rmi $new_image 2>/dev/null || true

            else
                echo "âŒ æ‹‰å–å¤±è´¥: $line"
            fi

        done < $IMAGES_FILE

        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if [[ "$IMAGES_FILE" == "temp_images.txt" ]]; then
            rm -f temp_images.txt
        fi

        echo ""
        echo "=============================================================================="
        echo "ğŸ“Š åŒæ­¥å®Œæˆç»Ÿè®¡:"
        echo "  ğŸ“‹ æ€»è®¡å¤„ç†: $TOTAL_COUNT ä¸ªé•œåƒ"
        echo "  âœ… æˆåŠŸåŒæ­¥: $SUCCESS_COUNT ä¸ªé•œåƒ"
        echo "  âŒ å¤±è´¥æ•°é‡: $((TOTAL_COUNT - SUCCESS_COUNT)) ä¸ªé•œåƒ"
        echo "=============================================================================="
