name: Docker

on:
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'å¼ºåˆ¶åŒæ­¥æ‰€æœ‰é•œåƒï¼ˆå¿½ç•¥ç°æœ‰ä»“åº“çŠ¶æ€ï¼‰'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
  push:
    branches: [ main ]
    paths:
      - 'images.txt'  # images.txtå˜åŒ–æ—¶è§¦å‘æ™ºèƒ½åŒæ­¥
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ8ç‚¹æ‰§è¡Œæ™ºèƒ½åŒæ­¥æ£€æŸ¥
    - cron: '0 0 * * *'


env:
  ALIYUN_REGISTRY: "${{ secrets.ALIYUN_REGISTRY }}"
  ALIYUN_NAME_SPACE: "${{ secrets.ALIYUN_NAME_SPACE }}"
  ALIYUN_REGISTRY_USER: "${{ secrets.ALIYUN_REGISTRY_USER }}"
  ALIYUN_REGISTRY_PASSWORD: "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}"

jobs:

  build:
    name: Pull
    runs-on: ubuntu-latest
    steps:
    - name: Before freeing up disk space
      run: |
        echo "Before freeing up disk space"
        echo "=============================================================================="
        df -hT
        echo "=============================================================================="

    # å¢åŠ å¯ç”¨ç£ç›˜ç©ºé—´
    - name: Maximize build space
      uses: easimon/maximize-build-space@master
      with:

        root-reserve-mb: 2048
        swap-size-mb: 128
        remove-dotnet: 'true'
        remove-haskell: 'true'
        # å¦‚æœç©ºé—´è¿˜æ˜¯ä¸å¤Ÿç”¨ï¼Œå¯ä»¥æŠŠä»¥ä¸‹å¼€å¯ï¼Œæ¸…ç†å‡ºæ›´å¤šç©ºé—´
        # remove-android: 'true'
        # remove-codeql: 'true'
        build-mount-path: '/var/lib/docker/'

    - name: Restart docker
      run: sudo service docker restart

    - name: Free up disk space complete
      run: |
        echo "Free up disk space complete"
        echo "=============================================================================="
        df -hT
        echo "=============================================================================="

    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Docker Setup Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and push image Aliyun
      run: |
        docker login -u $ALIYUN_REGISTRY_USER -p $ALIYUN_REGISTRY_PASSWORD $ALIYUN_REGISTRY

        echo "ğŸ” æ™ºèƒ½é•œåƒåŒæ­¥ç³»ç»Ÿå¯åŠ¨..."
        echo "=============================================================================="

        # ä»ç¯å¢ƒå˜é‡è§£æé˜¿é‡Œäº‘ä»“åº“åœ°å€
        if [[ "$ALIYUN_REGISTRY" =~ ^registry\.([^.]+)\.aliyuncs\.com$ ]]; then
            REGION="${BASH_REMATCH[1]}"
            echo "ğŸ“ æ£€æµ‹åˆ°é˜¿é‡Œäº‘åŒºåŸŸ: $REGION"
        else
            echo "âš ï¸  æ— æ³•è§£æé˜¿é‡Œäº‘åŒºåŸŸï¼Œä½¿ç”¨é»˜è®¤: hangzhou"
            REGION="hangzhou"
        fi

        # é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡APIåŸºç¡€URL
        API_BASE="https://cr.$REGION.aliyuncs.com/v2"
        NAMESPACE_API="https://cr.$REGION.aliyuncs.com/v2/namespaces"

        echo "ğŸ”— APIåœ°å€: $API_BASE"
        echo "ğŸ“‚ å‘½åç©ºé—´: $ALIYUN_NAME_SPACE"
        echo "=============================================================================="

        # è·å–é˜¿é‡Œäº‘ä»“åº“ä¸­å·²æœ‰çš„é•œåƒåˆ—è¡¨
        echo "ğŸ“Š æ­£åœ¨æŸ¥è¯¢é˜¿é‡Œäº‘ä»“åº“ä¸­çš„é•œåƒ..."

        # æ„å»ºè®¤è¯token
        AUTH_TOKEN=$(echo -n "$ALIYUN_REGISTRY_USER:$ALIYUN_REGISTRY_PASSWORD" | base64)

        # è·å–å‘½åç©ºé—´ä¿¡æ¯
        echo "ğŸ” è·å–å‘½åç©ºé—´ä¿¡æ¯..."
        NAMESPACE_RESPONSE=$(curl -s -H "Authorization: Basic $AUTH_TOKEN" \
            "$NAMESPACE_API/$ALIYUN_NAME_SPACE/repositories?page=1&page_size=100" || echo "{}")

        # è§£æJSONå“åº”è·å–ä»“åº“åˆ—è¡¨
        if echo "$NAMESPACE_RESPONSE" | grep -q '"repositories"'; then
            echo "âœ… æˆåŠŸè·å–ä»“åº“åˆ—è¡¨"

            # æå–ä»“åº“åç§°
            EXISTING_REPOS=$(echo "$NAMESPACE_RESPONSE" | grep -o '"name":"[^"]*"' | sed 's/"name":"//g' | sed 's/"//g' || echo "")

            if [[ -n "$EXISTING_REPOS" ]]; then
                echo "ğŸ“¦ å‘ç°ç°æœ‰ä»“åº“:"
                echo "$EXISTING_REPOS" | while read repo; do
                    if [[ -n "$repo" ]]; then
                        echo "  - $repo"
                    fi
                done
            else
                echo "â„¹ï¸  å‘½åç©ºé—´ä¸­æš‚æ— ä»“åº“"
            fi
        else
            echo "âš ï¸  è·å–ä»“åº“åˆ—è¡¨å¤±è´¥ï¼Œå°†è¿›è¡Œå…¨é‡åŒæ­¥"
            EXISTING_REPOS=""
        fi

        echo "=============================================================================="

        # åˆ†æimages.txtä¸­çš„é•œåƒéœ€æ±‚
        echo "ğŸ” åˆ†æé•œåƒåŒæ­¥éœ€æ±‚..."

        NEEDED_IMAGES=""
        TOTAL_IMAGES=0
        NEEDED_COUNT=0

        while IFS= read -r line || [ -n "$line" ]; do
            # å¿½ç•¥ç©ºè¡Œä¸æ³¨é‡Š
            [[ -z "$line" ]] && continue
            if echo "$line" | grep -q '^\s*#'; then
                continue
            fi

            ((TOTAL_IMAGES++))

            # æå–é•œåƒä¿¡æ¯
            if echo "$line" | grep -q -- '--platform'; then
                image=$(echo "$line" | awk '{print $NF}')
                platform=$(echo "$line" | awk -F'--platform[ =]' '{if (NF>1) print $2}' | awk '{print $1}')
            else
                image="$line"
                platform=""
            fi

            # è§£æé•œåƒåå’Œæ ‡ç­¾
            if echo "$image" | grep -q ":"; then
                repo_part=$(echo "$image" | cut -d':' -f1)
                tag_part=$(echo "$image" | cut -d':' -f2)
            else
                repo_part="$image"
                tag_part="latest"
            fi

            # è·å–æœ€ç»ˆé•œåƒåï¼ˆå»é™¤å‘½åç©ºé—´å‰ç¼€ï¼‰
            final_name=$(echo "$repo_part" | awk -F'/' '{print $NF}')
            final_image="${final_name}:${tag_part}"

            # å¤„ç†é‡åé•œåƒ
            if echo "$EXISTING_REPOS" | grep -q "^$final_name$"; then
                echo "âœ… é•œåƒå·²å­˜åœ¨: $final_image"
                # è¿™é‡Œå¯ä»¥è¿›ä¸€æ­¥æ£€æŸ¥æ ‡ç­¾æ˜¯å¦éœ€è¦æ›´æ–°
                # æš‚æ—¶å‡è®¾å·²å­˜åœ¨çš„é•œåƒä¸éœ€è¦æ›´æ–°
            else
                echo "ğŸ†• éœ€è¦åŒæ­¥: $final_image"
                ((NEEDED_COUNT++))
                if [[ -n "$NEEDED_IMAGES" ]]; then
                    NEEDED_IMAGES="$NEEDED_IMAGES$line"$'\n'
                else
                    NEEDED_IMAGES="$line"$'\n'
                fi
            fi

        done < images.txt

        echo "=============================================================================="
        echo "ğŸ“Š åŒæ­¥éœ€æ±‚åˆ†æç»“æœ:"
        echo "  ğŸ“‹ é…ç½®æ€»æ•°: $TOTAL_IMAGES ä¸ªé•œåƒ"
        echo "  âœ… å·²å­˜åœ¨: $((TOTAL_IMAGES - NEEDED_COUNT)) ä¸ªé•œåƒ"
        echo "  ğŸ†• éœ€è¦åŒæ­¥: $NEEDED_COUNT ä¸ªé•œåƒ"
        echo "=============================================================================="

        # å¦‚æœæ²¡æœ‰éœ€è¦åŒæ­¥çš„é•œåƒï¼Œç›´æ¥é€€å‡º
        if [[ $NEEDED_COUNT -eq 0 ]]; then
            echo "ğŸ‰ æ‰€æœ‰é•œåƒå·²å­˜åœ¨ï¼Œæ— éœ€åŒæ­¥"
            exit 0
        fi

        # åˆ›å»ºä¸´æ—¶æ–‡ä»¶åªåŒ…å«éœ€è¦åŒæ­¥çš„é•œåƒ
        echo "$NEEDED_IMAGES" > temp_images.txt
        IMAGES_FILE="temp_images.txt"

        echo "ğŸš€ å¼€å§‹åŒæ­¥ç¼ºå¤±çš„é•œåƒ..."

        # æ•°æ®é¢„å¤„ç†,åˆ¤æ–­é•œåƒæ˜¯å¦é‡å
        declare -A duplicate_images
        declare -A temp_map
        while IFS= read -r line || [ -n "$line" ]]; do
            # å¿½ç•¥ç©ºè¡Œä¸æ³¨é‡Š
            [[ -z "$line" ]] && continue
            if echo "$line" | grep -q '^\s*#'; then
                continue
            fi

            # è·å–é•œåƒçš„å®Œæ•´åç§°ï¼Œä¾‹å¦‚kasmweb/nginx:1.25.3ï¼ˆå‘½åç©ºé—´/é•œåƒå:ç‰ˆæœ¬å·ï¼‰
            image=$(echo "$line" | awk '{print $NF}')
            # å°†@sha256:ç­‰å­—ç¬¦åˆ é™¤
            image="${image%%@*}"
            echo "image $image"
            # è·å–é•œåƒå:ç‰ˆæœ¬å·  ä¾‹å¦‚nginx:1.25.3
            image_name_tag=$(echo "$image" | awk -F'/' '{print $NF}')
            echo "image_name_tag $image_name_tag"
            # è·å–å‘½åç©ºé—´ ä¾‹å¦‚kasmweb,  è¿™é‡Œæœ‰ç§ç‰¹æ®Šæƒ…å†µ docker.io/nginxï¼ŒæŠŠdocker.ioå½“æˆå‘½åç©ºé—´ï¼Œä¹ŸOK
            name_space=$(echo "$image" | awk -F'/' '{if (NF==3) print $2; else if (NF==2) print $1; else print ""}')
            echo "name_space: $name_space"
            # è¿™é‡Œä¸è¦æ˜¯ç©ºå€¼å½±å“åˆ¤æ–­
            name_space="${name_space}_"
            # è·å–é•œåƒåä¾‹å¦‚nginx
            image_name=$(echo "$image_name_tag" | awk -F':' '{print $1}')
            echo "image_name: $image_name"

            # å¦‚æœé•œåƒå­˜åœ¨äºæ•°ç»„ä¸­ï¼Œåˆ™æ·»åŠ temp_map
            if [[ -n "${temp_map[$image_name]}" ]]; then
                 # å¦‚æœtemp_mapå·²ç»å­˜åœ¨é•œåƒåï¼Œåˆ¤æ–­æ˜¯ä¸æ˜¯åŒä¸€å‘½åç©ºé—´
                 if [[ "${temp_map[$image_name]}" != $name_space  ]]; then
                    echo "duplicate image name: $image_name"
                    duplicate_images[$image_name]="true"
                 fi
            else
                # å­˜é•œåƒçš„å‘½åç©ºé—´
                temp_map[$image_name]=$name_space
            fi
        done < $IMAGES_FILE

        echo ""
        echo "ğŸ”„ å¼€å§‹å¤„ç†é•œåƒæ‹‰å–å’Œæ¨é€..."

        TOTAL_COUNT=0
        SUCCESS_COUNT=0

        while IFS= read -r line || [ -n "$line" ]; do
            # å¿½ç•¥ç©ºè¡Œä¸æ³¨é‡Š
            [[ -z "$line" ]] && continue
            if echo "$line" | grep -q '^\s*#'; then
                continue
            fi

            ((TOTAL_COUNT++))
            echo ""
            echo "ğŸ“¦ å¤„ç†é•œåƒ [$TOTAL_COUNT]: $line"

            echo "ğŸ”„ docker pull $line"
            if docker pull $line; then
                echo "âœ… æ‹‰å–æˆåŠŸ"
                platform=$(echo "$line" | awk -F'--platform[ =]' '{if (NF>1) print $2}' | awk '{print $1}')
                echo "platform is $platform"
                # å¦‚æœå­˜åœ¨æ¶æ„ä¿¡æ¯ å°†æ¶æ„ä¿¡æ¯æ‹¼åˆ°é•œåƒåç§°å‰é¢
                if [ -z "$platform" ]; then
                    platform_prefix=""
                else
                    platform_prefix="${platform//\//_}_"
                fi
                echo "platform_prefix is $platform_prefix"
                # è·å–é•œåƒçš„å®Œæ•´åç§°ï¼Œä¾‹å¦‚kasmweb/nginx:1.25.3ï¼ˆå‘½åç©ºé—´/é•œåƒå:ç‰ˆæœ¬å·ï¼‰
                image=$(echo "$line" | awk '{print $NF}')

                # è·å– é•œåƒå:ç‰ˆæœ¬å·  ä¾‹å¦‚nginx:1.25.3
                image_name_tag=$(echo "$image" | awk -F'/' '{print $NF}')
                # è·å–å‘½åç©ºé—´ ä¾‹å¦‚kasmweb  è¿™é‡Œæœ‰ç§ç‰¹æ®Šæƒ…å†µ docker.io/nginxï¼ŒæŠŠdocker.ioå½“æˆå‘½åç©ºé—´ï¼Œä¹ŸOK
                name_space=$(echo "$image" | awk -F'/' '{if (NF==3) print $2; else if (NF==2) print $1; else print ""}')
                # è·å–é•œåƒåä¾‹  ä¾‹å¦‚nginx
                image_name=$(echo "$image_name_tag" | awk -F':' '{print $1}')

                name_space_prefix=""
                # å¦‚æœé•œåƒåé‡å
                if [[ -n "${duplicate_images[$image_name]}" ]]; then
                   #å¦‚æœå‘½åç©ºé—´éç©ºï¼Œå°†å‘½åç©ºé—´åŠ åˆ°å‰ç¼€
                   if [[ -n "${name_space}" ]]; then
                      name_space_prefix="${name_space}_"
                   fi
                fi

                # å°†@sha256:ç­‰å­—ç¬¦åˆ é™¤
                image_name_tag="${image_name_tag%%@*}"
                new_image="$ALIYUN_REGISTRY/$ALIYUN_NAME_SPACE/$platform_prefix$name_space_prefix$image_name_tag"
                echo "ğŸ·ï¸  docker tag $image $new_image"
                docker tag $image $new_image
                echo "ğŸ“¤ docker push $new_image"
                if docker push $new_image; then
                    ((SUCCESS_COUNT++))
                    echo "âœ… æ¨é€æˆåŠŸ: $new_image"
                else
                    echo "âŒ æ¨é€å¤±è´¥: $new_image"
                fi

                # æ¸…ç†æœ¬åœ°é•œåƒ
                echo "ğŸ§¹ æ¸…ç†æœ¬åœ°é•œåƒ..."
                docker rmi $image 2>/dev/null || true
                docker rmi $new_image 2>/dev/null || true

            else
                echo "âŒ æ‹‰å–å¤±è´¥: $line"
            fi

        done < $IMAGES_FILE

        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if [[ "$IMAGES_FILE" == "temp_images.txt" ]]; then
            rm -f temp_images.txt
        fi

        echo ""
        echo "=============================================================================="
        echo "ğŸ“Š æ™ºèƒ½åŒæ­¥å®Œæˆç»Ÿè®¡:"
        echo "  ğŸ“‹ é…ç½®æ€»æ•°: $TOTAL_IMAGES ä¸ªé•œåƒ"
        echo "  ğŸ†• æ–°å¢åŒæ­¥: $SUCCESS_COUNT ä¸ªé•œåƒ"
        echo "  âŒ å¤±è´¥æ•°é‡: $((TOTAL_COUNT - SUCCESS_COUNT)) ä¸ªé•œåƒ"
        echo "=============================================================================="
