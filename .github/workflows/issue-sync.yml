name: Issue Triggered Sync

on:
  issues:
    types: [opened]

jobs:
  sync:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'sync') && github.event.issue.state == 'open'

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # å¢žåŠ å¯ç”¨ç£ç›˜ç©ºé—´
    - name: Maximize build space
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 2048
        swap-size-mb: 128
        remove-dotnet: 'true'
        remove-haskell: 'true'
        build-mount-path: '/var/lib/docker/'

    - name: Docker Environment Setup
      run: |
        # ä½¿ç”¨å…±äº«çš„DockerçŽ¯å¢ƒè®¾ç½®è„šæœ¬
        ./scripts/docker-setup.sh

    - name: Docker Setup Buildx
      uses: docker/setup-buildx-action@v3

    - name: Extract images from structured issue form
      run: |
        # ä»Žç»“æž„åŒ–Issueè¡¨å•ä¸­æå–é•œåƒåˆ—è¡¨
        echo "ðŸ” ä»ŽIssueä¸­æå–é•œåƒåˆ—è¡¨..."
        echo "Raw issue body:"
        echo "=========================================="
        echo "${{ github.event.issue.body }}"
        echo "=========================================="

        # åˆ›å»ºPythonè„šæœ¬æ¥è§£æžç»“æž„åŒ–Issueè¡¨å•
        cat > parse_issue.py << 'EOF'
        import re
        import sys

        def extract_images_from_issue(issue_body):
            """ä»Žç»“æž„åŒ–Issueè¡¨å•ä¸­æå–é•œåƒåˆ—è¡¨"""
            images = []

            # æ–¹æ³•1: æŸ¥æ‰¾ä»£ç å—ä¸­çš„å†…å®¹ ```bash æˆ– ``` ```
            code_block_pattern = r'```(?:bash)?\s*\n(.*?)\n```'
            code_blocks = re.findall(code_block_pattern, issue_body, re.DOTALL)

            for block in code_blocks:
                lines = block.strip().split('\n')
                for line in lines:
                    line = line.strip()
                    if line and not line.startswith('#'):
                        images.append(line)

            # æ–¹æ³•2: æŸ¥æ‰¾ "### ðŸ“¦ é•œåƒåˆ—è¡¨" æ ‡é¢˜ä¸‹çš„å†…å®¹
            if not images:
                # åŒ¹é…ä»¥ ### å¼€å¤´çš„æ ‡é¢˜è¡Œï¼ŒåŽé¢è·Ÿç€å†…å®¹
                # å¤„ç†å¤šç§å¯èƒ½çš„æ ‡é¢˜æ ¼å¼
                patterns = [
                    r'###\s*[ðŸ“¦]?\s*é•œåƒåˆ—è¡¨\s*\n\n(.*?)(?=\n###|\n--|\Z)',
                    r'###\s*[ðŸ“¦]?\s*é•œåƒåˆ—è¡¨\s*\n(.*?)(?=\n###|\n--|\Z)',
                    r'###\s*images\s*\n\n(.*?)(?=\n###|\n--|\Z)',
                    r'###\s*images\s*\n(.*?)(?=\n###|\n--|\Z)'
                ]

                for pattern in patterns:
                    matches = re.findall(pattern, issue_body, re.DOTALL | re.MULTILINE)
                    for match in matches:
                        lines = match.strip().split('\n')
                        for line in lines:
                            line = line.strip()
                            # è¿‡æ»¤æœ‰æ•ˆçš„é•œåƒæ ¼å¼
                            if (line and
                                not line.startswith('#') and
                                not line.startswith('>') and
                                not line.startswith('-') and
                                not line.startswith('*') and
                                not line.startswith('`') and
                                not line.startswith('--')):
                                # æ£€æŸ¥æ˜¯å¦åƒé•œåƒåç§°ï¼ˆåŒ…å«å†’å·æˆ–æ–œæ ï¼‰
                                if (':' in line or '/' in line or
                                    line.startswith('--platform=') or
                                    re.match(r'^[a-zA-Z0-9][a-zA-Z0-9._/-]*$', line)):
                                    images.append(line)

            # æ–¹æ³•3: å¦‚æžœè¿˜æ²¡æ‰¾åˆ°ï¼Œå°è¯•æ›´å®½æ¾çš„åŒ¹é…
            if not images:
                # ç›´æŽ¥æŸ¥æ‰¾çœ‹èµ·æ¥åƒé•œåƒçš„è¡Œ
                lines = issue_body.split('\n')
                for line in lines:
                    line = line.strip()
                    if (line and
                        not line.startswith('#') and
                        not line.startswith('>') and
                        not line.startswith('-') and
                        not line.startswith('*') and
                        not line.startswith('`') and
                        not line.startswith('###') and
                        not line.startswith('##') and
                        not line.startswith('#') and
                        not line.startswith('**') and
                        not line.startswith('*') and
                        not line.startswith('_') and
                        not line.startswith('---')):

                        # æ£€æŸ¥æ˜¯å¦åƒé•œåƒåç§°
                        if (':' in line or '/' in line or
                            line.startswith('--platform=') or
                            re.match(r'^[a-zA-Z0-9][a-zA-Z0-9._/-]*$', line)):
                            images.append(line)

            return images

        # è¯»å–Issueå†…å®¹
        issue_body = """${{ github.event.issue.body }}"""

        # æå–é•œåƒåˆ—è¡¨
        images = extract_images_from_issue(issue_body)

        # è¾“å‡ºç»“æžœ
        if images:
            print("âœ… æˆåŠŸæå–é•œåƒåˆ—è¡¨:")
            for img in images:
                print(f"  {img}")

            # ä¿å­˜åˆ°æ–‡ä»¶
            with open('issue_images.txt', 'w') as f:
                for img in images:
                    f.write(f"{img}\n")

            print(f"\nðŸ“Š å…±æå–åˆ° {len(images)} ä¸ªé•œåƒ")
        else:
            print("âŒ æœªæ‰¾åˆ°æœ‰æ•ˆçš„é•œåƒåˆ—è¡¨")
            print("è¯·æ£€æŸ¥Issueæ ¼å¼ï¼Œç¡®ä¿é•œåƒåˆ—è¡¨å¡«å†™æ­£ç¡®")
            sys.exit(1)
        EOF

        # è¿è¡ŒPythonè„šæœ¬
        python3 parse_issue.py

        # æ˜¾ç¤ºæå–çš„é•œåƒ
        echo "ðŸ“‹ æœ€ç»ˆæå–åˆ°çš„é•œåƒ:"
        cat issue_images.txt | sed 's/^/  > /'

        # æ›´å®‰å…¨çš„è®¡æ•°æ–¹æ³•
        if [ -s issue_images.txt ]; then
          IMAGE_COUNT=$(wc -l < issue_images.txt | tr -d ' ')
        else
          IMAGE_COUNT=0
        fi

        echo "ðŸ“Š æ‰¾åˆ° $IMAGE_COUNT ä¸ªé•œåƒ"

        # å¦‚æžœæ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆé•œåƒï¼Œé€€å‡º
        if [ "$IMAGE_COUNT" -eq 0 ]; then
          echo "âŒ æœªåœ¨Issueä¸­æ‰¾åˆ°æœ‰æ•ˆçš„é•œåƒåˆ—è¡¨"
          echo "è¯·æ£€æŸ¥Issueæ ¼å¼ï¼Œæ¯è¡Œä¸€ä¸ªé•œåƒåç§°"
          exit 1
        fi

        # è®¾ç½®çŽ¯å¢ƒå˜é‡ä¾›åŽç»­æ­¥éª¤ä½¿ç”¨
        echo "IMAGE_COUNT=$IMAGE_COUNT" >> $GITHUB_ENV

        # æ¸…ç†ä¸´æ—¶è„šæœ¬
        rm -f parse_issue.py

    - name: Docker login and sync using unified processor
      run: |
        set -e

        # ç™»å½•é˜¿é‡Œäº‘ä»“åº“
        docker login -u $ALIYUN_REGISTRY_USER -p $ALIYUN_REGISTRY_PASSWORD $ALIYUN_REGISTRY

        echo "ðŸš€ å¼€å§‹Issueè§¦å‘çš„é•œåƒåŒæ­¥..."
        echo "=============================================================================="

        # å°†Issueå†…å®¹è½¬æ¢ä¸ºJSONé…ç½®
        python3 ./scripts/issue_to_json.py issue_images.txt issue_images.json

        # ä½¿ç”¨ç»Ÿä¸€å¤„ç†å™¨è¿›è¡ŒåŒæ­¥
        ./scripts/unified_sync.py -f -c issue_images.json -o issue-sync-result.env

        # è¯»å–ç»“æžœå¹¶è®¾ç½®çŽ¯å¢ƒå˜é‡
        if [ -f issue-sync-result.env ]; then
            source issue-sync-result.env
        fi

        # ä¿å­˜ç»“æžœç”¨äºŽè¯„è®º
        echo "TOTAL_COUNT=$TOTAL_COUNT" >> $GITHUB_ENV
        echo "SUCCESS_COUNT=$SUCCESS_COUNT" >> $GITHUB_ENV
        echo "FAILED_COUNT=$FAILED_COUNT" >> $GITHUB_ENV

        # ä¿å­˜æˆåŠŸå’Œå¤±è´¥çš„é•œåƒåˆ—è¡¨
        if [ "$SUCCESS_COUNT" -gt 0 ]; then
            echo "SUCCESS_IMAGES=\"$SUCCESS_IMAGES\"" >> $GITHUB_ENV
        else
            echo 'SUCCESS_IMAGES=""' >> $GITHUB_ENV
        fi

        if [ "$FAILED_COUNT" -gt 0 ]; then
            echo "FAILED_IMAGES=\"$FAILED_IMAGES\"" >> $GITHUB_ENV
        else
            echo 'FAILED_IMAGES=""' >> $GITHUB_ENV
        fi

        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -f issue_images.txt issue_images.json issue-sync-result.env

    - name: Add final comment
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const totalCount = process.env.TOTAL_COUNT || 0;
          const successCount = process.env.SUCCESS_COUNT || 0;
          const skippedCount = parseInt(process.env.SKIPPED_COUNT || 0);
          const failedCount = totalCount - successCount - skippedCount;

          // èŽ·å–æˆåŠŸå’Œå¤±è´¥çš„é•œåƒåˆ—è¡¨
          const successImages = process.env.SUCCESS_IMAGES || '';
          const failedImages = process.env.FAILED_IMAGES || '';

          let statusEmoji = 'âœ…';
          let statusText = 'å…¨éƒ¨æˆåŠŸ';

          if (failedCount > 0) {
            if (successCount === 0 && skippedCount === 0) {
              statusEmoji = 'âŒ';
              statusText = 'å…¨éƒ¨å¤±è´¥';
            } else {
              statusEmoji = 'âš ï¸';
              statusText = 'éƒ¨åˆ†æˆåŠŸ';
            }
          } else if (skippedCount > 0 && successCount === 0) {
            statusEmoji = 'â­ï¸';
            statusText = 'å…¨éƒ¨å·²å­˜åœ¨';
          }

          const timestamp = new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' });

          // æž„å»ºè¯¦ç»†æŠ¥å‘Š
          let detailedReport = '';

          if (successImages.trim()) {
            detailedReport += '\n### âœ… æˆåŠŸåŒæ­¥çš„é•œåƒ:\n';
            detailedReport += '```\n' + successImages.trim() + '\n```\n';
          }

          if (failedImages.trim()) {
            detailedReport += '\n### âŒ å¤±è´¥çš„é•œåƒ:\n';
            detailedReport += '```\n' + failedImages.trim() + '\n```\n';
          }

          let statistics = `- ðŸ“‹ å¤„ç†æ€»æ•°: ${totalCount} ä¸ªé•œåƒ\n- âœ… æˆåŠŸåŒæ­¥: ${successCount} ä¸ªé•œåƒ\n- â­ï¸ è·³è¿‡å·²å­˜åœ¨: ${skippedCount} ä¸ªé•œåƒ\n- âŒ å¤±è´¥æ•°é‡: ${failedCount} ä¸ªé•œåƒ`;

          const commentBody = `## ${statusEmoji} æ™ºèƒ½åŒæ­¥å®Œæˆ\n\n**çŠ¶æ€**: ${statusText}\n\nðŸ“Š **åŒæ­¥ç»Ÿè®¡**:\n${statistics}${detailedReport}\n---\n*ç”± GitHub Actions æ™ºèƒ½å¤„ç† â€¢ ${timestamp}*`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: commentBody
          });

          // å¦‚æžœå…¨éƒ¨æˆåŠŸæˆ–å…¨éƒ¨å·²å­˜åœ¨ï¼Œå…³é—­ issue
          if (failedCount === 0 && parseInt(totalCount) > 0) {
            github.rest.issues.update({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed'
            });
          }

    env:
      ALIYUN_REGISTRY: ${{ secrets.ALIYUN_REGISTRY }}
      ALIYUN_NAME_SPACE: ${{ secrets.ALIYUN_NAME_SPACE }}
      ALIYUN_REGISTRY_USER: ${{ secrets.ALIYUN_REGISTRY_USER }}
      ALIYUN_REGISTRY_PASSWORD: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}