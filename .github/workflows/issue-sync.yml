name: Issue Triggered Sync

on:
  issues:
    types: [opened]

jobs:
  sync:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'sync') && github.event.issue.state == 'open'

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Maximize build space
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 2048
        swap-size-mb: 128
        remove-dotnet: 'true'
        remove-haskell: 'true'
        build-mount-path: '/var/lib/docker/'

    - name: Restart docker
      run: sudo service docker restart

    - name: Docker Setup Buildx
      uses: docker/setup-buildx-action@v3

    - name: Extract images from issue
      id: extract
      run: |
        # ä» issue body ä¸­æå–é•œåƒåˆ—è¡¨ï¼Œæ ¼å¼ä¸ images.txt ç›¸åŒ
        echo "Extracting images from issue..."

        # ä½¿ç”¨æ›´å¯é çš„æ–¹æ³•æå–ä»£ç å—ä¸­çš„å†…å®¹
        # å°†issue bodyå†™å…¥ä¸´æ—¶æ–‡ä»¶
        cat << 'EOF' > issue_body.txt
${{ github.event.issue.body }}
EOF

        # æå–ä»£ç å—ä¸­çš„å†…å®¹
        IMAGES=$(sed -n '/```/,/```/p' issue_body.txt | sed '1d;$d')

        # è¿‡æ»¤å‡ºæœ‰æ•ˆçš„é•œåƒè¡Œï¼ˆæ’é™¤ç©ºè¡Œå’Œæ³¨é‡Šï¼‰
        echo "$IMAGES" | grep -v '^#' | grep -v '^$' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' > issue_images.txt

        # æ˜¾ç¤ºæå–çš„é•œåƒå’Œè°ƒè¯•ä¿¡æ¯
        echo "Raw extracted images:"
        echo "$IMAGES"
        echo "---"
        echo "Filtered images to sync:"
        cat issue_images.txt
        echo "---"
        echo "Valid image count:"
        VALID_IMAGES=$(cat issue_images.txt | grep -v '^$' | wc -l)
        echo "$VALID_IMAGES"
        echo "---"
        echo "File content check:"
        echo "File exists: $(test -f issue_images.txt && echo 'YES' || echo 'NO')"
        echo "File size: $(test -f issue_images.txt && wc -l < issue_images.txt || echo '0')"
        echo "File content (hex):"
        test -f issue_images.txt && hexdump -C issue_images.txt | head -5 || echo "No file"
        echo "Original issue body (first 200 chars):"
        head -c 200 issue_body.txt
        echo ""
        echo "---"

        echo "image_count=$VALID_IMAGES" >> $GITHUB_OUTPUT

        if [ $VALID_IMAGES -eq 0 ]; then
          echo "No valid images found in issue"
          echo "Full issue body:"
          cat issue_body.txt
          exit 1
        fi

        echo "Found $VALID_IMAGES valid images to sync"

  
    - name: Docker login and sync
      run: |
        set +e

        # ç™»å½•é˜¿é‡Œäº‘ä»“åº“
        docker login -u $ALIYUN_REGISTRY_USER -p $ALIYUN_REGISTRY_PASSWORD $ALIYUN_REGISTRY

        echo "ğŸ” å¼€å§‹é•œåƒåŒæ­¥..."
        echo "=============================================================================="

        TOTAL_COUNT=0
        SUCCESS_COUNT=0

        while IFS= read -r line || [ -n "$line" ]; do
          # å¿½ç•¥ç©ºè¡Œä¸æ³¨é‡Š
          [[ -z "$line" ]] && continue
          if echo "$line" | grep -q '^\s*#'; then
            continue
          fi

          ((TOTAL_COUNT++))
          echo ""
          echo "ğŸ“¦ å¤„ç†é•œåƒ [$TOTAL_COUNT]: $line"

          # æ£€æŸ¥æ˜¯å¦åŒ…å«å¹³å°å‚æ•°
          PLATFORM_PARAM=""
          IMAGE_NAME="$line"
          if echo "$line" | grep -q -- '--platform'; then
            PLATFORM_PARAM=$(echo "$line" | awk -F'--platform[ =]' '{if (NF>1) print $2}' | awk '{print $1}')
            IMAGE_NAME=$(echo "$line" | awk '{print $NF}')
          fi

          echo "ğŸ”„ docker pull $line"
          if docker pull $line; then
            echo "âœ… æ‹‰å–æˆåŠŸ"

            # ç”Ÿæˆç›®æ ‡é•œåƒå
            if [ -n "$PLATFORM_PARAM" ]; then
              PLATFORM_PREFIX="${PLATFORM_PARAM//\//_}_"
            else
              PLATFORM_PREFIX=""
            fi

            # è·å–é•œåƒåŸºæœ¬ä¿¡æ¯
            IMAGE_NAME_TAG=$(echo "$IMAGE_NAME" | awk -F'/' '{print $NF}')
            NEW_IMAGE="$ALIYUN_REGISTRY/$ALIYUN_NAME_SPACE/$PLATFORM_PREFIX$IMAGE_NAME_TAG"

            echo "ğŸ·ï¸  docker tag $IMAGE_NAME $NEW_IMAGE"
            docker tag $IMAGE_NAME $NEW_IMAGE

            echo "ğŸ“¤ docker push $NEW_IMAGE"
            if docker push $NEW_IMAGE; then
              ((SUCCESS_COUNT++))
              echo "âœ… æ¨é€æˆåŠŸ: $NEW_IMAGE"
            else
              echo "âŒ æ¨é€å¤±è´¥: $NEW_IMAGE"
            fi

            # æ¸…ç†æœ¬åœ°é•œåƒ
            echo "ğŸ§¹ æ¸…ç†æœ¬åœ°é•œåƒ..."
            docker rmi $IMAGE_NAME 2>/dev/null || true
            docker rmi $NEW_IMAGE 2>/dev/null || true

          else
            echo "âŒ æ‹‰å–å¤±è´¥: $line"
          fi

        done < issue_images.txt

        echo ""
        echo "=============================================================================="
        echo "ğŸ“Š åŒæ­¥å®Œæˆç»Ÿè®¡:"
        echo "  ğŸ“‹ å¤„ç†æ€»æ•°: $TOTAL_COUNT ä¸ªé•œåƒ"
        echo "  âœ… æˆåŠŸåŒæ­¥: $SUCCESS_COUNT ä¸ªé•œåƒ"
        echo "  âŒ å¤±è´¥æ•°é‡: $((TOTAL_COUNT - SUCCESS_COUNT)) ä¸ªé•œåƒ"
        echo "=============================================================================="

        # ä¿å­˜ç»“æœç”¨äºè¯„è®º - ç¡®ä¿è®¡æ•°ä¸€è‡´
        echo "total_count=$TOTAL_COUNT" >> $GITHUB_ENV
        echo "success_count=$SUCCESS_COUNT" >> $GITHUB_ENV

    - name: Add final comment
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const totalCount = process.env.TOTAL_COUNT || 0;
          const successCount = process.env.SUCCESS_COUNT || 0;
          const failedCount = totalCount - successCount;

          let statusEmoji = 'âœ…';
          let statusText = 'å…¨éƒ¨æˆåŠŸ';

          if (failedCount > 0) {
            if (successCount === 0) {
              statusEmoji = 'âŒ';
              statusText = 'å…¨éƒ¨å¤±è´¥';
            } else {
              statusEmoji = 'âš ï¸';
              statusText = 'éƒ¨åˆ†æˆåŠŸ';
            }
          }

          const timestamp = new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' });

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ${statusEmoji} åŒæ­¥å®Œæˆ\n\n**çŠ¶æ€**: ${statusText}\n\nğŸ“Š **åŒæ­¥ç»Ÿè®¡**:\n- ğŸ“‹ å¤„ç†æ€»æ•°: ${totalCount} ä¸ªé•œåƒ\n- âœ… æˆåŠŸåŒæ­¥: ${successCount} ä¸ªé•œåƒ\n- âŒ å¤±è´¥æ•°é‡: ${failedCount} ä¸ªé•œåƒ\n\n---\n*ç”± GitHub Actions è‡ªåŠ¨å¤„ç† â€¢ ${timestamp}*`
          });

          // å¦‚æœå…¨éƒ¨æˆåŠŸï¼Œå…³é—­ issue
          if (failedCount === 0 && parseInt(totalCount) > 0) {
            github.rest.issues.update({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed'
            });
          }

    env:
      ALIYUN_REGISTRY: ${{ secrets.ALIYUN_REGISTRY }}
      ALIYUN_NAME_SPACE: ${{ secrets.ALIYUN_NAME_SPACE }}
      ALIYUN_REGISTRY_USER: ${{ secrets.ALIYUN_REGISTRY_USER }}
      ALIYUN_REGISTRY_PASSWORD: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}