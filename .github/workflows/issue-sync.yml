name: Issue Triggered Sync

on:
  issues:
    types: [opened]

jobs:
  sync:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'sync') && github.event.issue.state == 'open'

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # å¢åŠ å¯ç”¨ç£ç›˜ç©ºé—´
    - name: Maximize build space
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 2048
        swap-size-mb: 128
        remove-dotnet: 'true'
        remove-haskell: 'true'
        build-mount-path: '/var/lib/docker/'

    - name: Docker Environment Setup
      run: |
        # ä½¿ç”¨å…±äº«çš„Dockerç¯å¢ƒè®¾ç½®è„šæœ¬
        ./scripts/docker-setup.sh

    - name: Docker Setup Buildx
      uses: docker/setup-buildx-action@v3

    - name: Extract images from issue
      id: extract
      run: |
        # ä½¿ç”¨é•œåƒå¤„ç†è„šæœ¬æå–é•œåƒ
        # ä½¿ç”¨heredocé¿å…shellè¯­æ³•é”™è¯¯
        ./scripts/image-processor.sh -i "$(cat << 'EOF'
        ${{ github.event.issue.body }}
        EOF
        )" -o extract-result.env -r extract

    - name: Docker login and sync
      run: |
        set +e

        # ç™»å½•é˜¿é‡Œäº‘ä»“åº“
        docker login -u $ALIYUN_REGISTRY_USER -p $ALIYUN_REGISTRY_PASSWORD $ALIYUN_REGISTRY

        echo "ğŸ” å¼€å§‹é•œåƒåŒæ­¥..."
        echo "=============================================================================="

        # ä»æå–ç»“æœä¸­è¯»å–é•œåƒæ•°é‡
        if [ -f extract-result.env ]; then
            source extract-result.env
        fi

        # å¦‚æœæ²¡æœ‰æœ‰æ•ˆé•œåƒï¼Œé€€å‡º
        if [ "${image_count:-0}" -eq 0 ]; then
            echo "No valid images found in issue"
            echo "Full issue body:"
            echo "${{ github.event.issue.body }}"
            exit 1
        fi

        echo "Found ${image_count:-0} valid images to sync"

        # è°ƒè¯•ï¼šæ‰“å°æå–çš„é•œåƒå†…å®¹
        echo "ğŸ” è°ƒè¯•ä¿¡æ¯ï¼šextracted_images.txt å†…å®¹"
        echo "=============================================="
        if [ -f extracted_images.txt ]; then
            echo "ğŸ“ extracted_images.txt å­˜åœ¨ï¼Œå†…å®¹å¦‚ä¸‹ï¼š"
            cat extracted_images.txt
            echo ""
            echo "ğŸ“Š æ–‡ä»¶è¡Œæ•°: $(cat extracted_images.txt | wc -l)"
            echo "ğŸ“Š æ–‡ä»¶å¤§å°: $(wc -c < extracted_images.txt) å­—èŠ‚"
        else
            echo "âŒ extracted_images.txt æ–‡ä»¶ä¸å­˜åœ¨ï¼"
        fi
        echo "=============================================="

        # ä½¿ç”¨é•œåƒå¤„ç†è„šæœ¬è¿›è¡Œæ™ºèƒ½åŒæ­¥ï¼ˆè·³è¿‡å·²å­˜åœ¨çš„é•œåƒï¼‰
        ./scripts/image-processor.sh -f extracted_images.txt -o sync-result.env -s

        # è¯»å–ç»“æœå¹¶è®¾ç½®ç¯å¢ƒå˜é‡
        if [ -f sync-result.env ]; then
            source sync-result.env
        fi

        # ä¿å­˜ç»“æœç”¨äºè¯„è®º - ç¡®ä¿è®¡æ•°ä¸€è‡´
        echo "TOTAL_COUNT=$TOTAL_COUNT" >> $GITHUB_ENV
        echo "SUCCESS_COUNT=$SUCCESS_COUNT" >> $GITHUB_ENV
        echo "SKIPPED_COUNT=$SKIPPED_COUNT" >> $GITHUB_ENV

        # ä¿å­˜æˆåŠŸå’Œå¤±è´¥çš„é•œåƒåˆ—è¡¨
        echo "SUCCESS_IMAGES<<EOF" >> $GITHUB_ENV
        echo "$SUCCESS_IMAGES" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV

        echo "FAILED_IMAGES<<EOF" >> $GITHUB_ENV
        echo "$FAILED_IMAGES" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV

        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -f extract-result.env sync-result.env extracted_images.txt

    - name: Add final comment
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const totalCount = process.env.TOTAL_COUNT || 0;
          const successCount = process.env.SUCCESS_COUNT || 0;
          const skippedCount = parseInt(process.env.SKIPPED_COUNT || 0);
          const failedCount = totalCount - successCount - skippedCount;

          // è·å–æˆåŠŸå’Œå¤±è´¥çš„é•œåƒåˆ—è¡¨
          const successImages = process.env.SUCCESS_IMAGES || '';
          const failedImages = process.env.FAILED_IMAGES || '';

          let statusEmoji = 'âœ…';
          let statusText = 'å…¨éƒ¨æˆåŠŸ';

          if (failedCount > 0) {
            if (successCount === 0 && skippedCount === 0) {
              statusEmoji = 'âŒ';
              statusText = 'å…¨éƒ¨å¤±è´¥';
            } else {
              statusEmoji = 'âš ï¸';
              statusText = 'éƒ¨åˆ†æˆåŠŸ';
            }
          } else if (skippedCount > 0 && successCount === 0) {
            statusEmoji = 'â­ï¸';
            statusText = 'å…¨éƒ¨å·²å­˜åœ¨';
          }

          const timestamp = new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' });

          // æ„å»ºè¯¦ç»†æŠ¥å‘Š
          let detailedReport = '';

          if (successImages.trim()) {
            detailedReport += '\n### âœ… æˆåŠŸåŒæ­¥çš„é•œåƒ:\n';
            detailedReport += '```\n' + successImages.trim() + '\n```\n';
          }

          if (failedImages.trim()) {
            detailedReport += '\n### âŒ å¤±è´¥çš„é•œåƒ:\n';
            detailedReport += '```\n' + failedImages.trim() + '\n```\n';
          }

          let statistics = `- ğŸ“‹ å¤„ç†æ€»æ•°: ${totalCount} ä¸ªé•œåƒ\n- âœ… æˆåŠŸåŒæ­¥: ${successCount} ä¸ªé•œåƒ\n- â­ï¸ è·³è¿‡å·²å­˜åœ¨: ${skippedCount} ä¸ªé•œåƒ\n- âŒ å¤±è´¥æ•°é‡: ${failedCount} ä¸ªé•œåƒ`;

          const commentBody = `## ${statusEmoji} æ™ºèƒ½åŒæ­¥å®Œæˆ\n\n**çŠ¶æ€**: ${statusText}\n\nğŸ“Š **åŒæ­¥ç»Ÿè®¡**:\n${statistics}${detailedReport}\n---\n*ç”± GitHub Actions æ™ºèƒ½å¤„ç† â€¢ ${timestamp}*`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: commentBody
          });

          // å¦‚æœå…¨éƒ¨æˆåŠŸæˆ–å…¨éƒ¨å·²å­˜åœ¨ï¼Œå…³é—­ issue
          if (failedCount === 0 && parseInt(totalCount) > 0) {
            github.rest.issues.update({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed'
            });
          }

    env:
      ALIYUN_REGISTRY: ${{ secrets.ALIYUN_REGISTRY }}
      ALIYUN_NAME_SPACE: ${{ secrets.ALIYUN_NAME_SPACE }}
      ALIYUN_REGISTRY_USER: ${{ secrets.ALIYUN_REGISTRY_USER }}
      ALIYUN_REGISTRY_PASSWORD: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}