name: Issue Triggered Sync

on:
  issues:
    types: [opened]

jobs:
  sync:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'sync') && github.event.issue.state == 'open'

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Maximize build space
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 2048
        swap-size-mb: 128
        remove-dotnet: 'true'
        remove-haskell: 'true'
        build-mount-path: '/var/lib/docker/'

    - name: Restart docker
      run: sudo service docker restart

    - name: Docker Setup Buildx
      uses: docker/setup-buildx-action@v3

    - name: Extract images from issue
      id: extract
      run: |
        # ‰ªé issue body ‰∏≠ÊèêÂèñÈïúÂÉèÂàóË°®ÔºåÊ†ºÂºè‰∏é images.txt Áõ∏Âêå
        echo "Extracting images from issue..."

        # ÊèêÂèñ‰ª£Á†ÅÂùó‰∏≠ÁöÑÂÜÖÂÆπÔºåÊàñËÄÖÊèêÂèñÊâÄÊúâË°å
        IMAGES=$(echo '${{ github.event.issue.body }}' | sed -n '/```/,/```/p' | sed '1d;$d' || echo '${{ github.event.issue.body }}')

        # ËøáÊª§Âá∫ÊúâÊïàÁöÑÈïúÂÉèË°åÔºàÊéíÈô§Á©∫Ë°åÂíåÊ≥®ÈáäÔºâ
        echo "$IMAGES" | grep -v '^#' | grep -v '^$' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' > issue_images.txt

        # ÊòæÁ§∫ÊèêÂèñÁöÑÈïúÂÉè
        echo "Found images to sync:"
        cat issue_images.txt

        # ËÆæÁΩÆËæìÂá∫ÂèòÈáè
        IMAGE_COUNT=$(cat issue_images.txt | grep -v '^$' | wc -l)
        echo "image_count=$IMAGE_COUNT" >> $GITHUB_OUTPUT

        if [ $IMAGE_COUNT -eq 0 ]; then
          echo "No valid images found in issue"
          exit 1
        fi

    - name: Add initial comment
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## üöÄ ÂºÄÂßãÂêåÊ≠•ÈïúÂÉè\n\nÊ£ÄÊµãÂà∞ **${{ steps.extract.outputs.image_count }}** ‰∏™ÈïúÂÉèÈúÄË¶ÅÂêåÊ≠•Ôºö\n\nÊ≠£Âú®ÂáÜÂ§áÂêåÊ≠•ÁéØÂ¢ÉÔºåËØ∑Á®çÂÄô...`
          });

    - name: Docker login and sync
      run: |
        set +e

        # ÁôªÂΩïÈòøÈáå‰∫ë‰ªìÂ∫ì
        docker login -u $ALIYUN_REGISTRY_USER -p $ALIYUN_REGISTRY_PASSWORD $ALIYUN_REGISTRY

        echo "üîç ÂºÄÂßãÈïúÂÉèÂêåÊ≠•..."
        echo "=============================================================================="

        TOTAL_COUNT=0
        SUCCESS_COUNT=0

        while IFS= read -r line || [ -n "$line" ]; do
          # ÂøΩÁï•Á©∫Ë°å‰∏éÊ≥®Èáä
          [[ -z "$line" ]] && continue
          if echo "$line" | grep -q '^\s*#'; then
            continue
          fi

          ((TOTAL_COUNT++))
          echo ""
          echo "üì¶ Â§ÑÁêÜÈïúÂÉè [$TOTAL_COUNT]: $line"

          # Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´Âπ≥Âè∞ÂèÇÊï∞
          PLATFORM_PARAM=""
          IMAGE_NAME="$line"
          if echo "$line" | grep -q -- '--platform'; then
            PLATFORM_PARAM=$(echo "$line" | awk -F'--platform[ =]' '{if (NF>1) print $2}' | awk '{print $1}')
            IMAGE_NAME=$(echo "$line" | awk '{print $NF}')
          fi

          echo "üîÑ docker pull $line"
          if docker pull $line; then
            echo "‚úÖ ÊãâÂèñÊàêÂäü"

            # ÁîüÊàêÁõÆÊ†áÈïúÂÉèÂêç
            if [ -n "$PLATFORM_PARAM" ]; then
              PLATFORM_PREFIX="${PLATFORM_PARAM//\//_}_"
            else
              PLATFORM_PREFIX=""
            fi

            # Ëé∑ÂèñÈïúÂÉèÂü∫Êú¨‰ø°ÊÅØ
            IMAGE_NAME_TAG=$(echo "$IMAGE_NAME" | awk -F'/' '{print $NF}')
            NEW_IMAGE="$ALIYUN_REGISTRY/$ALIYUN_NAME_SPACE/$PLATFORM_PREFIX$IMAGE_NAME_TAG"

            echo "üè∑Ô∏è  docker tag $IMAGE_NAME $NEW_IMAGE"
            docker tag $IMAGE_NAME $NEW_IMAGE

            echo "üì§ docker push $NEW_IMAGE"
            if docker push $NEW_IMAGE; then
              ((SUCCESS_COUNT++))
              echo "‚úÖ Êé®ÈÄÅÊàêÂäü: $NEW_IMAGE"
            else
              echo "‚ùå Êé®ÈÄÅÂ§±Ë¥•: $NEW_IMAGE"
            fi

            # Ê∏ÖÁêÜÊú¨Âú∞ÈïúÂÉè
            echo "üßπ Ê∏ÖÁêÜÊú¨Âú∞ÈïúÂÉè..."
            docker rmi $IMAGE_NAME 2>/dev/null || true
            docker rmi $NEW_IMAGE 2>/dev/null || true

          else
            echo "‚ùå ÊãâÂèñÂ§±Ë¥•: $line"
          fi

        done < issue_images.txt

        echo ""
        echo "=============================================================================="
        echo "üìä ÂêåÊ≠•ÂÆåÊàêÁªüËÆ°:"
        echo "  üìã Â§ÑÁêÜÊÄªÊï∞: $TOTAL_COUNT ‰∏™ÈïúÂÉè"
        echo "  ‚úÖ ÊàêÂäüÂêåÊ≠•: $SUCCESS_COUNT ‰∏™ÈïúÂÉè"
        echo "  ‚ùå Â§±Ë¥•Êï∞Èáè: $((TOTAL_COUNT - SUCCESS_COUNT)) ‰∏™ÈïúÂÉè"
        echo "=============================================================================="

        # ‰øùÂ≠òÁªìÊûúÁî®‰∫éËØÑËÆ∫
        echo "total_count=$TOTAL_COUNT" >> $GITHUB_ENV
        echo "success_count=$SUCCESS_COUNT" >> $GITHUB_ENV

    - name: Add final comment
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const totalCount = process.env.TOTAL_COUNT || 0;
          const successCount = process.env.SUCCESS_COUNT || 0;
          const failedCount = totalCount - successCount;

          let statusEmoji = '‚úÖ';
          let statusText = 'ÂÖ®ÈÉ®ÊàêÂäü';

          if (failedCount > 0) {
            if (successCount === 0) {
              statusEmoji = '‚ùå';
              statusText = 'ÂÖ®ÈÉ®Â§±Ë¥•';
            } else {
              statusEmoji = '‚ö†Ô∏è';
              statusText = 'ÈÉ®ÂàÜÊàêÂäü';
            }
          }

          const timestamp = new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' });

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ${statusEmoji} ÂêåÊ≠•ÂÆåÊàê\n\n**Áä∂ÊÄÅ**: ${statusText}\n\nüìä **ÂêåÊ≠•ÁªüËÆ°**:\n- üìã Â§ÑÁêÜÊÄªÊï∞: ${totalCount} ‰∏™ÈïúÂÉè\n- ‚úÖ ÊàêÂäüÂêåÊ≠•: ${successCount} ‰∏™ÈïúÂÉè\n- ‚ùå Â§±Ë¥•Êï∞Èáè: ${failedCount} ‰∏™ÈïúÂÉè\n\n---\n*Áî± GitHub Actions Ëá™Âä®Â§ÑÁêÜ ‚Ä¢ ${timestamp}*`
          });

          // Â¶ÇÊûúÂÖ®ÈÉ®ÊàêÂäüÔºåÂÖ≥Èó≠ issue
          if (failedCount === 0 && parseInt(totalCount) > 0) {
            github.rest.issues.update({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed'
            });
          }

    env:
      ALIYUN_REGISTRY: ${{ secrets.ALIYUN_REGISTRY }}
      ALIYUN_NAME_SPACE: ${{ secrets.ALIYUN_NAME_SPACE }}
      ALIYUN_REGISTRY_USER: ${{ secrets.ALIYUN_REGISTRY_USER }}
      ALIYUN_REGISTRY_PASSWORD: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}