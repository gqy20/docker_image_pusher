name: Update Latest Images

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    # æ¯å‘¨ä¸€å‡Œæ™¨22ç‚¹æ‰§è¡Œï¼ˆUTCæ—¶é—´ï¼‰ï¼Œç›¸å½“äºåŒ—äº¬æ—¶é—´ä¸Šåˆ6ç‚¹
    - cron: '0 22 * * 0'

jobs:
  update-latest:
    name: Update Latest Version Images
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Docker
      uses: docker/setup-buildx-action@v3

    - name: Update Images Script
      run: |
        # è®¾ç½®å˜é‡
        IMAGES_FILE="images.txt"
        BACKUP_FILE="images.txt.backup"
        UPDATED=false

        echo "ğŸ” å¼€å§‹æ£€æŸ¥å¹¶æ›´æ–°æœ€æ–°ç‰ˆæœ¬çš„é•œåƒ..."
        echo "=============================================================================="

        # åˆ›å»ºå¤‡ä»½
        cp $IMAGES_FILE $BACKUP_FILE
        echo "âœ… å·²åˆ›å»ºå¤‡ä»½æ–‡ä»¶: $BACKUP_FILE"

        # è¯»å–å¹¶å¤„ç†images.txt
        while IFS= read -r line || [ -n "$line" ]; do
            # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Š
            [[ -z "$line" ]] && continue
            if echo "$line" | grep -q '^\s*#'; then
                continue
            fi

            echo "ğŸ” å¤„ç†é•œåƒ: $line"

            # æå–platformå‚æ•°å’Œé•œåƒå
            platform=""
            if echo "$line" | grep -q -- '--platform'; then
                platform=$(echo "$line" | awk -F'--platform[ =]' '{print $2}' | awk '{print $1}')
                image=$(echo "$line" | awk '{print $NF}')
            else
                image="$line"
            fi

            # è·å–é•œåƒåå’Œæ ‡ç­¾
            if echo "$image" | grep -q ":"; then
                repo=$(echo "$image" | cut -d':' -f1)
                tag=$(echo "$image" | cut -d':' -f2)
            else
                repo="$image"
                tag=""
            fi

            echo "  ğŸ“¦ ä»“åº“: $repo"
            echo "  ğŸ·ï¸  æ ‡ç­¾: $tag"
            echo "  ğŸ”§ æ¶æ„: $platform"

            # åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°
            should_update=false
            new_line="$line"

            if [[ -z "$tag" ]]; then
                # æ— ç‰ˆæœ¬æ ‡ç­¾ï¼Œéœ€è¦æ·»åŠ :latest
                should_update=true
                if [[ -n "$platform" ]]; then
                    new_line="--platform=$platform $repo:latest"
                else
                    new_line="$repo:latest"
                fi
                echo "  ğŸ“ æ— ç‰ˆæœ¬æ ‡ç­¾ï¼Œå°†æ·»åŠ :latest"
            elif [[ "$tag" == "latest" ]]; then
                # å·²ç»æ˜¯latestï¼Œæ— éœ€æ›´æ”¹
                echo "  âœ… å·²ç»æ˜¯latestç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°"
            else
                # æŒ‡å®šäº†ç‰ˆæœ¬ï¼Œä¿æŒä¸å˜
                echo "  ğŸ”’ æŒ‡å®šç‰ˆæœ¬ $tagï¼Œä¿æŒä¸å˜"
            fi

            # å¦‚æœéœ€è¦æ›´æ–°ï¼Œæ›´æ–°åŸæ–‡ä»¶
            if [[ "$should_update" == true ]]; then
                sed -i "s|^${line}$|${new_line}|g" $IMAGES_FILE
                echo "  ğŸ”„ å·²æ›´æ–°: $line â†’ $new_line"
                UPDATED=true
            fi

            echo ""
        done < $IMAGES_FILE

        echo "=============================================================================="

        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
        if [[ "$UPDATED" == true ]]; then
            echo "ğŸ‰ å‘ç°é•œåƒæ›´æ–°ï¼Œå¼€å§‹æäº¤æ›´æ”¹..."

            # æ£€æŸ¥gitçŠ¶æ€
            if [[ -n $(git status --porcelain $IMAGES_FILE) ]]; then
                echo "ğŸ“ æ­£åœ¨æäº¤æ›´æ”¹..."

                # é…ç½®gitç”¨æˆ·ä¿¡æ¯
                git config --local user.email "action@github.com"
                git config --local user.name "GitHub Action"

                # æ·»åŠ å¹¶æäº¤æ›´æ”¹
                git add $IMAGES_FILE
                git commit -m "chore: è‡ªåŠ¨æ›´æ–°latestç‰ˆæœ¬é•œåƒ

                - ä¸ºæœªæŒ‡å®šç‰ˆæœ¬çš„é•œåƒæ·»åŠ  :latest æ ‡ç­¾
                - ä¿æŒæŒ‡å®šç‰ˆæœ¬çš„é•œåƒä¸å˜
                - æ”¯æŒå¤šæ¶æ„é•œåƒçš„ç‰ˆæœ¬æ›´æ–°

                ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

                Co-Authored-By: GitHub Action <action@github.com>"

                # æ¨é€æ›´æ”¹
                git push

                echo "âœ… æ›´æ–°å·²æˆåŠŸæ¨é€åˆ°ä»“åº“ï¼"

                # æ˜¾ç¤ºæ›´æ–°å¯¹æ¯”
                echo ""
                echo "ğŸ“Š æ›´æ–°å¯¹æ¯”:"
                echo "=============================================================================="
                diff -u $BACKUP_FILE $IMAGES_FILE || true
                echo "=============================================================================="

            else
                echo "âŒ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
            fi
        else
            echo "ğŸ‘ æ‰€æœ‰é•œåƒç‰ˆæœ¬å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€æ›´æ–°"
        fi

        # æ¸…ç†å¤‡ä»½æ–‡ä»¶
        rm -f $BACKUP_FILE
        echo "ğŸ§¹ æ¸…ç†å®Œæˆ"

    - name: Trigger Docker Sync
      if: success()
      run: |
        echo "ğŸš€ è§¦å‘é•œåƒåŒæ­¥æµç¨‹..."
        # è¿™é‡Œå¯ä»¥é€šè¿‡APIè°ƒç”¨è§¦å‘dockeré•œåƒåŒæ­¥
        echo "é•œåƒåŒæ­¥å°†åœ¨ä¸‹ä¸€ä¸ªCI/CDæµç¨‹ä¸­è‡ªåŠ¨æ‰§è¡Œ"