name: Update Latest Images

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    # æ¯å‘¨ä¸€å‡Œæ™¨22ç‚¹æ‰§è¡Œï¼ˆUTCæ—¶é—´ï¼‰ï¼Œç›¸å½“äºåŒ—äº¬æ—¶é—´ä¸Šåˆ6ç‚¹
    - cron: '0 22 * * 0'

jobs:
  update-latest:
    name: Update Latest Version Images
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Docker
      uses: docker/setup-buildx-action@v3

    - name: Install jq
      run: sudo apt-get install -y jq

    - name: Update Images Script
      run: |
        IMAGES_FILE="images.json"
        BACKUP_FILE="images.json.backup"

        echo "ğŸ” å¼€å§‹æ£€æŸ¥å¹¶æ›´æ–°æœ€æ–°ç‰ˆæœ¬çš„é•œåƒ..."
        echo "=============================================================================="

        # éªŒè¯JSONæ ¼å¼
        if ! jq empty "$IMAGES_FILE" 2>/dev/null; then
          echo "âŒ JSONæ ¼å¼é”™è¯¯"
          exit 1
        fi

        # åˆ›å»ºå¤‡ä»½
        cp "$IMAGES_FILE" "$BACKUP_FILE"
        echo "âœ… å·²åˆ›å»ºå¤‡ä»½æ–‡ä»¶: $BACKUP_FILE"

        # ä½¿ç”¨jqæ‰¹é‡æ›´æ–°æ‰€æœ‰élatestçš„tagä¸ºlatest
        # ä¿æŒåŸæœ‰JSONç»“æ„ï¼Œä½¿ç”¨walkéå†ä¿®æ”¹
        jq '
          walk(
            if type == "object" and has("source") and (.source | type == "object") and (.source.tag | type == "string") and .source.tag != "latest" then
              .source.tag = "latest"
            else
              .
            end
          )
        ' "$BACKUP_FILE" > "$IMAGES_FILE" || {
          echo "âŒ jqå¤„ç†å¤±è´¥ï¼Œæ¢å¤å¤‡ä»½"
          cp "$BACKUP_FILE" "$IMAGES_FILE"
          exit 1
        }

        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if diff -q "$BACKUP_FILE" "$IMAGES_FILE" > /dev/null 2>&1; then
          echo "ğŸ‘ æ‰€æœ‰é•œåƒç‰ˆæœ¬å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€æ›´æ–°"
        else
          echo "ğŸ‰ å‘ç°é•œåƒæ›´æ–°ï¼Œå¼€å§‹æäº¤æ›´æ”¹..."

          # ç»Ÿè®¡æ›´æ–°çš„é•œåƒæ•°é‡
          UPDATED_COUNT=$(jq '
            [.images[] |
            if type == "object" and (.source.tag // "") != "latest" then
              .
            else empty end] | length
          ' "$BACKUP_FILE")

          echo "ğŸ“¦ å‘ç° $UPDATED_COUNT ä¸ªé•œåƒéœ€è¦æ›´æ–°:"
          jq -r '
            [.images[] |
            if type == "object" and (.source.tag // "") != "latest" then
              "  ğŸ”„ é•œåƒ[\(.id)]: \(.source.repository):\(.source.tag) â†’ \(.source.repository):latest"
            else empty end] | .[] | select(length > 0)
          ' "$BACKUP_FILE" 2>/dev/null || echo "  (æ— æ³•æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯)"
          echo ""

          # é…ç½®gitç”¨æˆ·ä¿¡æ¯
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # æ·»åŠ å¹¶æäº¤æ›´æ”¹
          git add "$IMAGES_FILE"
          git commit -m "chore: è‡ªåŠ¨æ›´æ–°latestç‰ˆæœ¬é•œåƒ

          - ä¸ºå·²é…ç½®é•œåƒç»Ÿä¸€æ·»åŠ  :latest æ ‡ç­¾
          - ä¿æŒæŒ‡å®šç‰ˆæœ¬çš„é•œåƒä¸å˜
          - åŒæ­¥æ›´æ–°é•œåƒé…ç½®

          ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

          Co-Authored-By: GitHub Action <action@github.com>"

          # æ¨é€æ›´æ”¹
          git push

          echo "âœ… æ›´æ–°å·²æˆåŠŸæ¨é€åˆ°ä»“åº“ï¼"
          echo ""
          echo "ğŸ“Š å˜æ›´ç»Ÿè®¡:"
          echo "=============================================================================="
          echo "æ›´æ–°çš„é•œåƒæ•°é‡: $UPDATED_COUNT"
          echo "=============================================================================="
        fi

        # æ¸…ç†å¤‡ä»½æ–‡ä»¶
        rm -f "$BACKUP_FILE"
        echo "ğŸ§¹ æ¸…ç†å®Œæˆ"

    - name: Trigger Docker Sync
      if: success()
      run: |
        echo "ğŸš€ è§¦å‘é•œåƒåŒæ­¥æµç¨‹..."
        echo "é•œåƒåŒæ­¥å°†åœ¨ä¸‹ä¸€ä¸ªCI/CDæµç¨‹ä¸­è‡ªåŠ¨æ‰§è¡Œ"
