name: Issue Triggered Sync (Simple)

on:
  issues:
    types: [opened]

jobs:
  sync:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'sync') && github.event.issue.state == 'open'

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Show issue info
      run: |
        echo "Issue title: ${{ github.event.issue.title }}"
        echo "Issue number: ${{ github.event.issue.number }}"
        echo "Issue body:"
        echo "${{ github.event.issue.body }}"

    - name: Extract images from issue
      id: extract
      run: |
        # ä» issue body ä¸­æå–é•œåƒåˆ—è¡¨
        echo "Extracting images from issue..."

        # æå–ä»£ç å—ä¸­çš„å†…å®¹
        IMAGES=$(echo '${{ github.event.issue.body }}' | sed -n '/```/,/```/p' | sed '1d;$d' || echo '')

        if [ -z "$IMAGES" ]; then
          echo "No images found in code blocks"
          exit 1
        fi

        echo "Found images to sync:"
        echo "$IMAGES"

        # ä¿å­˜åˆ°æ–‡ä»¶
        echo "$IMAGES" > issue_images.txt

        # è®¾ç½®è¾“å‡ºå˜é‡
        IMAGE_COUNT=$(echo "$IMAGES" | grep -v '^$' | wc -l)
        echo "image_count=$IMAGE_COUNT" >> $GITHUB_OUTPUT

    - name: Add initial comment
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ğŸš€ å¼€å§‹åŒæ­¥é•œåƒ\n\næ£€æµ‹åˆ° **${{ steps.extract.outputs.image_count }}** ä¸ªé•œåƒéœ€è¦åŒæ­¥ï¼š\n\n\`\`\`\n${{ github.event.issue.body }}\n\`\`\`\n\næ­£åœ¨å‡†å¤‡åŒæ­¥ç¯å¢ƒï¼Œè¯·ç¨å€™...`
          });

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.ALIYUN_REGISTRY_USER }}
        password: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}
        registry: ${{ secrets.ALIYUN_REGISTRY }}

    - name: Sync images
      run: |
        echo "Starting image sync..."
        TOTAL_COUNT=0
        SUCCESS_COUNT=0

        while IFS= read -r line || [ -n "$line" ]; do
          # è·³è¿‡ç©ºè¡Œ
          [[ -z "$line" ]] && continue

          ((TOTAL_COUNT++))
          echo ""
          echo "ğŸ“¦ å¤„ç†é•œåƒ [$TOTAL_COUNT]: $line"

          # æ‹‰å–é•œåƒ
          if docker pull $line; then
            echo "âœ… æ‹‰å–æˆåŠŸ"

            # ç”Ÿæˆç›®æ ‡é•œåƒå
            IMAGE_NAME_TAG=$(echo "$line" | awk -F'/' '{print $NF}')
            NEW_IMAGE="${{ secrets.ALIYUN_REGISTRY }}/${{ secrets.ALIYUN_NAME_SPACE }}/$IMAGE_NAME_TAG"

            echo "ğŸ·ï¸  docker tag $line $NEW_IMAGE"
            docker tag $line $NEW_IMAGE

            echo "ğŸ“¤ docker push $NEW_IMAGE"
            if docker push $NEW_IMAGE; then
              ((SUCCESS_COUNT++))
              echo "âœ… æ¨é€æˆåŠŸ: $NEW_IMAGE"
            else
              echo "âŒ æ¨é€å¤±è´¥: $NEW_IMAGE"
            fi

            # æ¸…ç†æœ¬åœ°é•œåƒ
            docker rmi $line 2>/dev/null || true
            docker rmi $NEW_IMAGE 2>/dev/null || true
          else
            echo "âŒ æ‹‰å–å¤±è´¥: $line"
          fi

        done < issue_images.txt

        echo ""
        echo "ğŸ“Š åŒæ­¥å®Œæˆç»Ÿè®¡:"
        echo "  ğŸ“‹ å¤„ç†æ€»æ•°: $TOTAL_COUNT ä¸ªé•œåƒ"
        echo "  âœ… æˆåŠŸåŒæ­¥: $SUCCESS_COUNT ä¸ªé•œåƒ"
        echo "  âŒ å¤±è´¥æ•°é‡: $((TOTAL_COUNT - SUCCESS_COUNT)) ä¸ªé•œåƒ"

        # ä¿å­˜ç»“æœç”¨äºè¯„è®º
        echo "total_count=$TOTAL_COUNT" >> $GITHUB_ENV
        echo "success_count=$SUCCESS_COUNT" >> $GITHUB_ENV

    - name: Add final comment
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const totalCount = process.env.TOTAL_COUNT || 0;
          const successCount = process.env.SUCCESS_COUNT || 0;
          const failedCount = totalCount - successCount;

          let statusEmoji = 'âœ…';
          let statusText = 'å…¨éƒ¨æˆåŠŸ';

          if (failedCount > 0) {
            if (successCount === 0) {
              statusEmoji = 'âŒ';
              statusText = 'å…¨éƒ¨å¤±è´¥';
            } else {
              statusEmoji = 'âš ï¸';
              statusText = 'éƒ¨åˆ†æˆåŠŸ';
            }
          }

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ${statusEmoji} åŒæ­¥å®Œæˆ\n\n**çŠ¶æ€**: ${statusText}\n\nğŸ“Š **åŒæ­¥ç»Ÿè®¡**:\n- ğŸ“‹ å¤„ç†æ€»æ•°: ${totalCount} ä¸ªé•œåƒ\n- âœ… æˆåŠŸåŒæ­¥: ${successCount} ä¸ªé•œåƒ\n- âŒ å¤±è´¥æ•°é‡: ${failedCount} ä¸ªé•œåƒ\n\n---
*ç”± GitHub Actions è‡ªåŠ¨å¤„ç† â€¢ ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}*`
          });

          // å¦‚æœå…¨éƒ¨æˆåŠŸï¼Œå…³é—­ issue
          if (failedCount === 0 && parseInt(totalCount) > 0) {
            github.rest.issues.update({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed'
            });
          }